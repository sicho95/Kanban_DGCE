<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KanBan DGCE</title>
    <style>
        .hamburger-menu-btn {
            background: none;
            border: none;
            color: #f5f5f7;
            cursor: pointer;
            padding: 8px 12px;
            margin-right: 10px;
            border-radius: 8px;
            transition: background 0.3s;
            font-size: 24px;
            line-height: 1;
        }

        .hamburger-menu-btn:hover {
            background: rgba(255,255,255,0.1);
        }

        .view-selector.filters {
            margin-left: auto;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: rgba(100,149,237,0.2);
            --primary-border: #6495ed;
            --primary-text: #6495ed;
        }

        body {
            font-family: 'SF Pro Display', 'Segoe UI', sans-serif;
            background: radial-gradient(circle at top left, rgba(50,48,47,0.96), rgba(20,20,20,0.98));
            color: #f5f5f7;
            overflow-x: hidden;
        }

        /* Header fixe */
        .header {
            position: sticky;
            top: 0;
            z-index: 900;
            background: rgba(55,55,55,0.95);
            backdrop-filter: blur(20px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            padding: 1rem 2rem;
            display: flex;
            justify-content: flex-start;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header h1 {
            font-size: 1.8rem;
            color: var(--primary-text);
            letter-spacing: 0.5px;
            margin: 0;
            margin-right: 33px;
        }

        .view-selector {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .view-btn, .filter-btn {
            padding: 0.6rem 1rem;
            background: rgba(255,255,255,0.12);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(255,255,255,0.08);
            color: #f5f5f7;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .view-btn:hover, .filter-btn:hover {
            background: rgba(255,255,255,0.16);
            
            box-shadow: 0 6px 20px rgba(255,255,255,0.08);
        }

        .view-btn.active {
            background: rgba(255,255,255,0.12);
            color: var(--primary-text);
            border-color: rgba(100,149,237,0.5);
            box-shadow: 0 4px 15px rgba(100,149,237,0.5);
        }

    .filter-btn.active {
        background: rgba(255,255,255,0.12);
        color: var(--primary-text);
        border-color: var(--primary-border);
        box-shadow: 0 4px 15px rgba(100,149,237,0.3);
    }


    
    /* Styles pour les boutons modals (dupliqu√© de filter-btn) */
    .btn {
        padding: 0.6rem 1rem;
        background: rgba(255, 255, 255, 0.12);
        backdrop-filter: blur(25px);
        border: 1px solid rgba(255, 255, 255, 0.08);
        color: #f5f5f7;
        border-radius: 12px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }

    .btn:hover {
        background: rgba(255, 255, 255, 0.16);
        box-shadow: 0 6px 20px rgba(255, 255, 255, 0.08);
    }

    .btn-secondary {
        padding: 0.6rem 1rem;
        background: rgba(255, 255, 255, 0.12);
        backdrop-filter: blur(25px);
        border: 1px solid rgba(255, 255, 255, 0.08);
        color: #f5f5f7;
        border-radius: 12px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }

    .btn-secondary:hover {
        background: rgba(255, 255, 255, 0.16);
        box-shadow: 0 6px 20px rgba(255, 255, 255, 0.08);
    }

        .kanban-container {
            padding: 2rem;
            display: flex;
            gap: 1.5rem;
            overflow-x: auto;
            min-height: calc(100vh - 120px);
        }

        .column {
            width: 350px;
            min-width: 350px;
            max-width: 350px;
            flex-shrink: 0;
            background: rgba(255,255,255,0.08);
            backdrop-filter: blur(30px);
            border-radius: 20px;
            padding: 1rem;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 8px 30px rgba(0,0,0,0.4);
            display: flex;
            flex-direction: column;
            gap: 1rem;
            transition: background 0.4s ease, transform 0.3s ease, box-shadow 0.3s ease;
            height: fit-content;
            cursor: move;
        }

        .column:hover {
            
            background: rgba(255,255,255,0.13);
            box-shadow: 0 10px 40px rgba(255,255,255,0.08);
        }

        .column.dragging-column {
            opacity: 0.5;
            cursor: grabbing;
        }

        .column.drag-over-column {
            border: 2px solid var(--primary-border);
            background: rgba(100,149,237,0.15);
        }

        .column-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-radius: 12px;
            position: relative;
            cursor: move;
        }

        .column-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #fff;
        }

        .column-badge {
            background: rgba(255,255,255,0.2);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-left: 10px;
        }

        .column-menu-container {
            position: relative;
        }

        .column-menu-btn {
            background: transparent;
            border: none;
            color: rgba(255,255,255,0.7);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px 10px;
            line-height: 1;
            transition: all 0.3s ease;
        }

        .column-menu-btn:hover {
            color: #fff;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
        }

        .column-menu-dropdown, .card-menu-dropdown {
            position: absolute;
            right: 0;
            top: 100%;
            background: rgba(40,40,40,0.95);
            backdrop-filter: blur(20px);
            border-radius: 12px;
            padding: 0.5rem 0;
            display: none;
            flex-direction: column;
            min-width: 160px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.5);
            z-index: 1000;
            margin-top: 5px;
        }

        .column-menu-dropdown.show, .card-menu-dropdown.show {
            display: flex;
        }

        .column-menu-dropdown button, .card-menu-dropdown button {
            background: none;
            border: none;
            text-align: left;
            color: #f5f5f7;
            padding: 0.7rem 1rem;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .column-menu-dropdown button:hover, .card-menu-dropdown button:hover {
            background: rgba(255,255,255,0.15);
        }

        .add-task-btn {
            background: rgba(255,255,255,0.12);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(255,255,255,0.08);
            color: #fff;
            border-radius: 12px;
            padding: 0.6rem 1rem;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            width: 100%;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            order: -1;
        }

        .add-task-btn:hover {
            background: rgba(255,255,255,0.18);
            
            box-shadow: 0 6px 20px rgba(255,255,255,0.08);
        }

        .cards-container {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
            min-height: 50px;
            flex: 1;
            max-height: 70vh;
            overflow-y: auto;
            padding-right: 5px;
        }

        .card {
            background: rgba(255,255,255,0.12);
            backdrop-filter: blur(25px);
            border-radius: 16px;
            padding: 1rem;
            border: 1px solid rgba(255,255,255,0.08);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: background 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease;
            cursor: grab;
            position: relative;
        }

        .card:active {
            cursor: grabbing;
        }

        .card:hover {
            
            background: rgba(255,255,255,0.16);
            box-shadow: 0 10px 25px rgba(255,255,255,0.08);
        }

        .card.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .cards-container.drag-over {
            background: rgba(100,149,237,0.2);
            border-radius: 12px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.8rem;
        }

        .card-title-container {
            flex: 1;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .card-title {
            font-size: 1rem;
            font-weight: 600;
            color: #fff;
            flex: 1;
        }

        .card-section {
            background: var(--primary-color);
            color: #f5f5f7;
            padding: 3px 10px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .card-menu-container {
            position: relative;
        }

        .card-menu-btn {
            background: transparent;
            border: none;
            color: rgba(255,255,255,0.6);
            font-size: 1.3rem;
            cursor: pointer;
            padding: 0 5px;
            line-height: 1;
            transition: all 0.3s ease;
        }

        .card-menu-btn:hover {
            color: #fff;
        }

        .card-description {
            font-size: 0.9rem;
            color: rgba(255,255,255,0.7);
            margin-bottom: 0.8rem;
            line-height: 1.4;
        }

        .card-meta span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .priority-tag {
            padding: 4px 10px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .priority-high { background: rgba(255,59,48,0.3); color: #ff6b6b; }
        .priority-medium { background: rgba(255,149,0,0.3); color: #ffb347; }
        .priority-low { background: rgba(52,199,89,0.3); color: #4cd964; }

        .progress {
            height: 14px;
            background: rgba(255,255,255,0.15);
            border-radius: 7px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4cd964, #34c759);
            border-radius: 7px;
            text-align: right;
            color: #fff;
            font-size: 0.75rem;
            line-height: 14px;
            padding-right: 5px;
            transition: width 0.3s ease;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(12px);
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .modal.show {
            display: flex;
            opacity: 1;
        }

        .modal-content {
            background: rgba(40,40,40,0.95);
            backdrop-filter: blur(25px);
            padding: 1.5rem 2rem;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            color: #fff;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
            display: flex;
            flex-direction: column;
            gap: 1rem;
            
            animation: slideIn 0.4s ease forwards;
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes slideIn {
            from { opacity: 0;  }
            to { opacity: 1;  }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .modal-header h2 {
            font-size: 1.5rem;
            color: var(--primary-text);
        }

        .close-modal {
            font-size: 2rem;
            color: rgba(255,255,255,0.6);
            cursor: pointer;
            transition: color 0.3s;
        }

        .close-modal:hover {
            color: #fff;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group label {
            font-weight: 600;
            color: rgba(255,255,255,0.9);
            font-size: 0.95rem;
        }

        .form-group input, .form-group select, .form-group textarea {
            padding: 0.8rem;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            color: #fff;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            background: rgba(255,255,255,0.15);
            border-color: var(--primary-text);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }

        .color-picker {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(45px, 1fr));
            gap: 10px;
            max-height: 250px;
            overflow-y: auto;
        }

        .color-option {
            width: 45px;
            height: 45px;
            border-radius: 12px;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .color-option:hover {
            transform: scale(1.1);
        }

        .color-option.selected {
            border-color: #fff;
            transform: scale(1.15);
            box-shadow: 0 0 15px rgba(255,255,255,0.5);
        }

        .calendar-view {
            display: none;
            padding: 2rem;
        }

        .calendar-view.show {
            display: block;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }

        .calendar-day {
            background: rgba(255,255,255,0.08);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 1rem;
            min-height: 120px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .calendar-day-header {
            font-weight: 600;
            color: var(--primary-text);
            margin-bottom: 0.5rem;
        }

        .calendar-task {
            background: rgba(255,255,255,0.1);
            padding: 0.5rem;
            border-radius: 8px;
            margin-top: 0.5rem;
            font-size: 0.85rem;
        }

        .overdue {
            border: 2px solid rgba(255,59,48,0.8);
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .header {
                top: 0;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .column {
                width: 300px;
                min-width: 300px;
                max-width: 300px;
            }

            .kanban-container {
                padding: 1.5rem;
            }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
                padding: 1rem;
                top: 0;
            }

            .header h1 {
                font-size: 1.3rem;
                width: 100%;
            }

            .view-selector {
                width: 100%;
                overflow-x: auto;
                flex-wrap: nowrap;
                padding-bottom: 5px;
            }

            .view-btn, .filter-btn {
                font-size: 13px;
                padding: 0.5rem 0.8rem;
                white-space: nowrap;
            }

            .btn, .btn-secondary {
                width: 100%;
            }

            .column {
                width: 280px;
                min-width: 280px;
                max-width: 280px;
            }

            .kanban-container {
                padding: 1rem;
            }

            .modal-content {
                width: 95%;
                padding: 1rem 1.5rem;
            }

            .color-picker {
                grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            }

            .color-option {
                width: 40px;
                height: 40px;
            }

            .calendar-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .cards-container {
                max-height: 60vh;
            }
        }

        @media (max-width: 480px) {
            .header {
                top: 0;
            }

            .header h1 {
                font-size: 1.2rem;
            }

            .view-btn, .filter-btn {
                font-size: 12px;
                padding: 0.4rem 0.7rem;
            }

            .column {
                width: 260px;
                min-width: 260px;
                max-width: 260px;
            }

            .column-title {
                font-size: 1rem;
            }

            .card-title {
                font-size: 0.95rem;
            }

            .calendar-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Pour les tablettes en mode paysage */
        @media (min-width: 769px) and (max-width: 1024px) {
            .calendar-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
    
        /* M√©tadonn√©es verticales */
        .card-meta {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: rgba(255,255,255,0.7);
            margin-bottom: 0.8rem;
        }

        .card-meta div {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Ressources en texte */
        .card-resources-text {
            font-size: 0.85rem;
            color: rgba(255,255,255,0.6);
            margin-bottom: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .calendar-task-detail { position: fixed; background: rgba(50,50,50,0.98); border: 1px solid #6495ed; border-radius: 12px; padding: 1.5rem; min-width: 320px; max-width: 420px; box-shadow: 0 10px 40px rgba(0,0,0,0.8); z-index: 1000; display: none; }
        .calendar-task-detail.show { display: block; }
        .calendar-task-detail-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; border-bottom: 1px solid rgba(100,149,237,0.3); padding-bottom: 0.75rem; gap: 1rem; }
        .calendar-task-detail-header-left { display: flex; align-items: center; gap: 0.75rem; flex: 1; min-width: 0; }
        .calendar-task-detail-header-right { display: flex; align-items: center; gap: 0.5rem; flex-shrink: 0; }
        .calendar-task-detail-title { font-size: 1.1rem; font-weight: 600; color: #f5f5f7; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .calendar-task-detail-section { display: inline-block; background: rgba(100,149,237,0.25); color: #ffffff; padding: 0.25rem 0.75rem; border-radius: 6px; font-size: 0.85rem; white-space: nowrap; flex-shrink: 0; }
        .calendar-task-detail-menu { position: relative; }
        .calendar-task-detail-menu-btn { background: none; border: none; color: #f5f5f7; font-size: 1.2rem; cursor: pointer; padding: 0.25rem; transition: color 0.2s ease; line-height: 1; }
        .calendar-task-detail-menu-btn:hover { color: #ffffff; }
        .calendar-task-detail-menu-dropdown { display: none; position: absolute; right: 0; top: 100%; margin-top: 0.5rem; background: rgba(40,40,40,0.95); border: 1px solid #6495ed; border-radius: 8px; min-width: 150px; box-shadow: 0 4px 12px rgba(0,0,0,0.5); z-index: 1001; }
        .calendar-task-detail-menu-dropdown.show { display: block; }
        .calendar-task-detail-menu-dropdown button { width: 100%; padding: 0.75rem 1rem; background: none; border: none; color: #f5f5f7; text-align: left; cursor: pointer; transition: background 0.2s ease; font-size: 0.9rem; }
        .calendar-task-detail-menu-dropdown button:hover { background: rgba(100,149,237,0.2); }
        .calendar-task-detail-close { background: none; border: none; color: #f5f5f7; font-size: 1.5rem; cursor: pointer; padding: 0; transition: color 0.2s ease; line-height: 1; }
        .calendar-task-detail-close:hover { color: #ffffff; }
        .calendar-task-detail-description { color: #d0d0d0; margin-bottom: 1rem; line-height: 1.5; }
        .calendar-task-detail-meta { display: flex; flex-direction: column; gap: 0.5rem; font-size: 0.9rem; color: #b0b0b0; }
        .calendar-task-detail-meta-item { display: flex; align-items: center; gap: 0.5rem; }
        .calendar-task-detail-progress { margin-top: 1rem; }
        .calendar-task-detail-progress-label { font-size: 0.85rem; color: #b0b0b0; margin-bottom: 0.5rem; }
        .calendar-task { cursor: pointer; transition: all 0.2s ease; }
        .calendar-task:hover { background: rgba(100,149,237,0.3);  }

    /* Colonne fictive "Ajouter colonne" */
    .add-column-placeholder {
        width: 350px;
        min-width: 350px;
        max-width: 350px;
        flex-shrink: 0;
        background: transparent;
        border: 2px dashed rgba(100, 149, 237, 0.4);
        border-radius: 20px;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        min-height: 200px;
        opacity: 0.6;
    }

    .add-column-placeholder:hover {
        background: rgba(100, 149, 237, 0.1);
        border-color: rgba(100, 149, 237, 0.7);
        opacity: 1;
    }

    .add-column-icon {
        font-size: 3rem;
        color: var(--primary-text);
        font-weight: 300;
    }

    .add-column-text {
        font-size: 1rem;
        color: rgba(245, 245, 247, 0.8);
        font-weight: 500;
        text-align: center;
    }

    @media (max-width: 768px) {
        .add-column-placeholder {
            width: 280px;
            min-width: 280px;
            max-width: 280px;
            min-height: 150px;
        }

        .add-column-icon {
            font-size: 2.5rem;
        }

        .add-column-text {
            font-size: 0.9rem;
        }
    }

    @media (max-width: 480px) {
        .add-column-placeholder {
            width: 260px;
            min-width: 260px;
            max-width: 260px;
        }
    }

    
    /* Footer copyright */
    .footer {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        text-align: center;
        padding: 8px 0;
        background: rgba(20, 20, 20, 0.8);
        backdrop-filter: blur(10px);
        color: rgba(255, 255, 255, 0.3);
        font-size: 11px;
        font-weight: 400;
        z-index: 800;
        border-top: 1px solid rgba(255, 255, 255, 0.05);
    }

    /* --- NAVIGATION CALENDRIER COMPACTE --- */
    .calendar-navigation { display: flex; justify-content: center; align-items: center; gap: 15px; margin-top: 5px; margin-bottom: 5px; padding: 5px; }

    .calendar-month-display {
        font-size: 18px;
        font-weight: 600;
        color: var(--primary-text);
        min-width: 160px;
        text-align: center;
        text-transform: capitalize;
    }

    /* Fl√®ches simples */
    .calendar-nav-arrow {
        background: transparent;
        border: none;
        color: var(--primary-text);
        cursor: pointer;
        font-size: 20px;
        padding: 2px 8px;
        transition: opacity 0.2s;
        display: flex;
        align-items: center;
    }
    .calendar-nav-arrow:hover {
        opacity: 0.7;
    }

    /* Bouton Aujourd'hui style "Filtre" (Similaire au bouton "Toutes les t√¢ches") */
    .calendar-today-btn { background: rgba(255, 255, 255, 0.1); border: none; color: #f5f5f7; padding: 8px 16px; border-radius: 6px; font-size: 14px; cursor: pointer; transition: background 0.3s; font-family: inherit; }

    .calendar-today-btn:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    /* Grille coll√©e √† la navigation */
    .calendar-grid {
        margin-top: 0 !important;
    }

    /* Halo subtil jour actuel */
    .calendar-day.today-highlight {
        box-shadow: 0 0 10px rgba(100,149,237,0.4);
        border: 1px solid rgba(100,149,237,0.6);
        position: relative;
        z-index: 5;
    }

    /* FORCER L'EQUILIBRE PARFAIT */
    .calendar-view {
        padding-top: 0 !important;
        margin-top: 0 !important;
    }

    .calendar-navigation {
        margin-top: 10px !important;    /* Espace Haut */
        margin-bottom: 10px !important; /* Espace Bas (identique) */
        padding: 0 !important;

        display: flex;
        justify-content: center;
        align-items: center;
        gap: 15px;
    }

    /* On s'assure que le bouton filter-btn s'affiche bien dans ce contexte */
    .calendar-navigation .filter-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        height: auto; /* Laisser le padding d√©finir la hauteur comme les autres */
    }

        /* ===== MODAL VISIBILITY FIX (V61) ===== */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 3000;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            overflow: auto;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal-content {
            position: relative;
            z-index: 3001;
            width: min(720px, 96vw);
            max-height: 92vh;
            overflow-y: auto;
        }
        .close-modal {
            position: absolute;
            top: 12px;
            right: 16px;
            z-index: 3002;
        }
        .modal.show {
            display: flex !important;
        }


/* ============================================ */
/* STYLES COMPTES RENDUS DE R√âUNION - V80     */
/* ============================================ */

/* Info box */
.info-box {
    background: rgba(33, 150, 243, 0.1);
    border-left: 4px solid #2196f3;
    padding: 15px;
    border-radius: 6px;
    margin-bottom: 25px;
    font-size: 13px;
    color: #64b5f6;
}

/* Utilisateur principal */
.user-card {
    background: rgba(142, 68, 173, 0.1);
    border: 2px solid rgba(142, 68, 173, 0.3);
    border-radius: 8px;
    padding: 20px;
    position: relative;
}

.user-badge {
    position: absolute;
    top: -12px;
    right: 20px;
    background: linear-gradient(135deg, #8e44ad, #9b59b6);
    color: white;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
}

.user-grid-4 {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
}

/* Grille 4 colonnes pour ressources */
.form-grid-4 {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
}

.form-field {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.form-field label {
    font-size: 12px;
    font-weight: 600;
    color: #aaa;
}

.form-field input {
    padding: 8px 12px;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 6px;
    color: #f5f5f7;
    font-size: 13px;
}

.form-field input:focus {
    border-color: rgba(142, 68, 173, 0.5);
    background: rgba(255,255,255,0.08);
    outline: none;
}

/* Liste des ressources */
.resources-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 20px;
    max-height: 400px;
    overflow-y: auto;
}

.resource-item {
    display: grid;
    grid-template-columns: 2fr 1.2fr 1.8fr 2fr auto;
    gap: 15px;
    align-items: center;
    padding: 12px 15px;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 6px;
    transition: all 0.2s;
}

.resource-item:hover {
    background: rgba(255,255,255,0.08);
    border-color: rgba(142, 68, 173, 0.3);
}

.resource-name {
    font-weight: 500;
    font-size: 14px;
    color: #f5f5f7;
}

.resource-grade,
.resource-unit,
.resource-email {
    color: #aaa;
    font-size: 13px;
}

/* Formulaire d'ajout */
.add-form {
    background: rgba(255,255,255,0.03);
    border: 2px dashed rgba(255,255,255,0.15);
    border-radius: 8px;
    padding: 20px;
    margin-top: 20px;
}

/* Tags */
.tags-container {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    padding: 12px;
    background: rgba(255,255,255,0.03);
    border-radius: 8px;
    min-height: 50px;
    border: 1px solid rgba(255,255,255,0.1);
}

.tags-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    padding: 15px;
    background: rgba(255,255,255,0.03);
    border-radius: 8px;
    min-height: 100px;
}

.tag-chip {
    padding: 8px 12px;
    background: rgba(142, 68, 173, 0.15);
    color: #ba68c8;
    border: 1px solid rgba(142, 68, 173, 0.3);
    border-radius: 16px;
    font-size: 12px;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-weight: 500;
}

.tag-chip button {
    background: rgba(244, 67, 54, 0.8);
    color: white;
    border: none;
    border-radius: 50%;
    width: 16px;
    height: 16px;
    cursor: pointer;
    font-size: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    transition: all 0.2s;
}

.tag-chip button:hover {
    background: #f44336;
    transform: scale(1.1);
}

/* Sections checkboxes */
.sections-checkboxes {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    padding: 15px;
    background: rgba(255,255,255,0.03);
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.1);
}

.section-checkbox {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 16px;
    background: rgba(255,255,255,0.05);
    border: 2px solid rgba(255,255,255,0.1);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 14px;
}

.section-checkbox:hover {
    background: rgba(255,255,255,0.08);
}

.section-checkbox.selected {
    background: rgba(33, 150, 243, 0.15);
    border-color: #2196f3;
    color: #64b5f6;
    font-weight: 500;
}

.section-checkbox input[type="checkbox"] {
    cursor: pointer;
}

/* Participants */
.participants-container {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    padding: 12px;
    background: rgba(255,255,255,0.03);
    border-radius: 8px;
    min-height: 60px;
    border: 1px solid rgba(255,255,255,0.1);
}

.participant-chip {
    padding: 6px 12px;
    border-radius: 16px;
    font-size: 13px;
    display: inline-flex;
    align-items: center;
    gap: 6px;
}

.chip-organizer {
    background: rgba(33, 150, 243, 0.2);
    color: #64b5f6;
    font-weight: 500;
    border: 1px solid rgba(33, 150, 243, 0.3);
}

.chip-attendee {
    background: rgba(255,255,255,0.08);
    color: #f5f5f7;
    border: 1px solid rgba(255,255,255,0.15);
}

.chip-remove {
    background: rgba(244, 67, 54, 0.8);
    color: white;
    border: none;
    border-radius: 50%;
    width: 16px;
    height: 16px;
    cursor: pointer;
    font-size: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    transition: all 0.2s;
}

.chip-remove:hover {
    background: #f44336;
    transform: scale(1.1);
}

/* Suggestions dropdown */
.suggestions-dropdown {
    display: none;
    position: relative;
    background: rgba(42, 42, 42, 0.98);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 6px;
    margin-top: 5px;
    max-height: 200px;
    overflow-y: auto;
    box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    z-index: 100;
}

.suggestion-item {
    padding: 10px 15px;
    cursor: pointer;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    transition: all 0.2s;
}

.suggestion-item:hover {
    background: rgba(142, 68, 173, 0.2);
}

.suggestion-item:last-child {
    border-bottom: none;
}

/* Tableaux */
.mr-table {
    width: 100%;
    border-collapse: collapse;
}

.mr-table th {
    background: rgba(255,255,255,0.08);
    padding: 10px;
    text-align: left;
    font-weight: 600;
    border: 1px solid rgba(255,255,255,0.1);
    font-size: 13px;
    color: #aaa;
}

.mr-table td {
    padding: 8px;
    border: 1px solid rgba(255,255,255,0.1);
}

.mr-table input,
.mr-table textarea {
    width: 100%;
    background: transparent;
    border: none;
    color: #f5f5f7;
    font-family: inherit;
    font-size: 13px;
    outline: none;
    padding: 4px;
}

.mr-table input:focus,
.mr-table textarea:focus {
    background: rgba(255,255,255,0.05);
}

.mr-table textarea {
    resize: vertical;
    min-height: 40px;
}

.mr-table tr.separator-row td {
    background: rgba(255,255,255,0.05);
    height: 8px;
    padding: 0;
    border: none;
}

/* Task chips dans les tableaux */
.task-chips-container {
    margin-top: 8px;
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
}

.task-chip {
    padding: 4px 8px;
    background: rgba(76, 175, 80, 0.2);
    border-left: 3px solid #4caf50;
    border-radius: 4px;
    font-size: 11px;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    transition: all 0.2s;
}

.task-chip:hover {
    background: rgba(76, 175, 80, 0.3);
}

/* Cartes CR dans la liste */
.mr-card {
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    border-left: 4px solid;
    border-radius: 8px;
    padding: 20px;
    cursor: pointer;
    transition: all 0.2s;
}

.mr-card:hover {
    background: rgba(255,255,255,0.08);
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.4);
}

.mr-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}

.mr-card-title {
    font-size: 16px;
    font-weight: 600;
    flex: 1;
    color: #f5f5f7;
}

.mr-status-badge {
    padding: 5px 14px;
    border-radius: 14px;
    font-size: 12px;
    font-weight: 500;
}

.mr-status-brouillon {
    background: rgba(158, 158, 158, 0.2);
    color: #bdbdbd;
    border: 1px solid rgba(158, 158, 158, 0.3);
}

.mr-status-encours {
    background: rgba(255, 152, 0, 0.2);
    color: #ffb74d;
    border: 1px solid rgba(255, 152, 0, 0.3);
}

.mr-status-valide {
    background: rgba(76, 175, 80, 0.2);
    color: #81c784;
    border: 1px solid rgba(76, 175, 80, 0.3);
}

.mr-meta {
    display: flex;
    gap: 20px;
    font-size: 13px;
    color: #aaa;
    margin-top: 10px;
}

.mr-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 12px;
}

.mr-tag {
    padding: 4px 10px;
    background: rgba(142, 68, 173, 0.15);
    color: #ba68c8;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 500;
    border: 1px solid rgba(142, 68, 173, 0.25);
}

/* Boutons sp√©cifiques CR */
.btn-small {
    padding: 6px 12px;
    font-size: 12px;
}

/* Help icon */
.help-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 18px;
    height: 18px;
    background: rgba(255,255,255,0.1);
    border-radius: 50%;
    font-size: 12px;
    cursor: help;
    color: #aaa;
}

/* Int√©gration calendrier */
.calendar-task.meeting {
    background: rgba(142, 68, 173, 0.2) !important;
    border-left-color: #8e44ad !important;
    color: #ba68c8 !important;
}

/* Responsive */
@media (max-width: 1024px) {
    .form-grid-4, .user-grid-4 {
        grid-template-columns: repeat(2, 1fr);
    }

    .resource-item {
        grid-template-columns: 1fr;
        gap: 8px;
    }
}

@media (max-width: 768px) {
    .form-grid-4, .user-grid-4 {
        grid-template-columns: 1fr;
    }
}



/* Correctif final pour le bouton R√©unions */
button[onclick*="reunions"] {
    display: inline-flex !important;
    order: -1 !important; /* Force la 1√®re position */
    background: rgba(142, 68, 173, 0.25) !important; /* Fond violet l√©ger pour le distinguer */
    border: 1px solid #8e44ad !important;
    font-weight: 600 !important;
}

/* S'assurer que le header laisse de la place */
.view-selector {
    flex: 1; /* Prend l'espace disponible */
    min-width: 0; /* √âvite les probl√®mes de flex overflow */
}


/* R√©unions: bouton actif (texte bleu + contour violet) */
#btn-reunions.active {
    color: #6495ed !important;
    border-color: #8e44ad !important;
    box-shadow: 0 4px 15px rgba(142, 68, 173, 0.35) !important;
}

/* R√©unions: grille de cartes */
.meeting-reports-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
    gap: 20px;
}
</style>
</head>
<body>
    <div class="header">
        <button class="hamburger-menu-btn" onclick="toggleSettingsMenu()" title="Menu"><span>‚ò∞</span></button>
            <h1>‚úÖ KanBan DGCE</h1>
        
            <button id="btn-reunions" class="view-btn" onclick="switchView('reunions')" data-section-color="#8e44ad">üìã R√©unions</button>
<div class="view-selector">
            <button class="view-btn" onclick="switchView('reunions')" data-section-color="#8e44ad">üìã R√©unions</button>
            <button class="view-btn active" onclick="switchView('general')">G√©n√©ral</button>
            <button class="view-btn" onclick="switchView('soa')">SOA</button>
            <button class="view-btn" onclick="switchView('smsc')">SMSC</button>
            <button class="view-btn" onclick="switchView('sosc')">SOSC</button>
            <button class="view-btn" onclick="switchView('sbo')">SBO</button>
            <button class="view-btn" onclick="switchView('transverse')">Transverse</button>
        </div>
        <div class="view-selector filters">
            <button class="filter-btn" onclick="showAllTasks()">Toutes les t√¢ches</button>
            <button class="filter-btn" onclick="filterOverdue()">En retard</button>
            <button class="filter-btn" onclick="filterThisWeek()">Cette semaine</button>
            <button class="filter-btn" onclick="filterThisMonth()">Ce mois</button>
            <button class="filter-btn" onclick="showCalendar()">üìÖ Calendrier</button>
        </div>
    </div>

    <div class="kanban-container" id="kanbanContainer"></div>
    
    

    <!-- VUE R√âUNIONS (Int√©gr√©e) -->
    <div id="reunionsView" style="display:none; padding: 20px; height: calc(100vh - 140px); overflow-y: auto;">
        <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom: 20px; gap: 15px; flex-wrap: wrap;">
            <h2 style="margin: 0;">üìã Comptes Rendus de R√©union</h2>
            <button class="btn" onclick="openMeetingReportModal()"><span style="color:#ffffff; font-size:16px;">‚ûï</span> Nouveau Compte Rendu</button>
        </div>
        <div id="meetingReportsList" class="meeting-reports-grid"></div>
    </div>
<div class="calendar-view" 

    
id="calendarView">
        
        
        <div class="calendar-navigation">
            <button class="calendar-nav-arrow" onclick="previousMonth()">&#9664;</button>
            <div class="calendar-month-display" id="calendarMonthDisplay"></div>
            <button class="calendar-nav-arrow" onclick="nextMonth()">&#9654;</button>
            <button class="filter-btn" onclick="goToToday()" style="margin:0;">Aujourd'hui</button>
        </div>
<div class="calendar-grid" id="calendarGrid"></div>
    </div>

    <div class="calendar-task-detail" id="calendarTaskDetail">
        <div class="calendar-task-detail-header">
            <div class="calendar-task-detail-header-left">
                <h3 class="calendar-task-detail-title" id="detailTitle"></h3>
                <div class="calendar-task-detail-section" id="detailSection"></div>
            </div>
            <div class="calendar-task-detail-header-right">
                <div class="calendar-task-detail-menu">
                    <button class="calendar-task-detail-menu-btn" onclick="toggleDetailMenu(event)">‚ãÆ</button>
                    <div class="calendar-task-detail-menu-dropdown" id="detailMenu">
                        <button onclick="editCardFromDetail()">‚úèÔ∏è Modifier</button>
                        <button onclick="deleteCardFromDetail()">üóëÔ∏è Supprimer</button>
                    </div>
                </div>
                <button class="calendar-task-detail-close" onclick="closeTaskDetail()">√ó</button>
            </div>
        </div>
        <div class="calendar-task-detail-description" id="detailDescription" style="display: none;"></div>
        <div class="calendar-task-detail-meta" id="detailMeta"></div>
        <div class="calendar-task-detail-progress" id="detailProgressContainer" style="display: none;">
            <div class="calendar-task-detail-progress-label">Progression</div>
            <div class="progress">
                <div class="progress-fill" id="detailProgress"></div>
            </div>
        </div>
    </div>

    <!-- Modal Colonne -->
    <div class="modal" id="columnModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="columnModalTitle">Ajouter/Modifier une colonne</h2>
                <span class="close-modal" onclick="closeModal('columnModal')">&times;</span>
            </div>
            <div class="form-group">
                <label>Titre de la colonne</label>
                <input type="text" id="columnTitle" placeholder="Ex: √Ä faire">
            </div>
            <div class="form-group" id="existingColumnGroup">
                <label>Ou choisir une colonne existante</label>
                <select id="existingColumnSelect" onchange="handleExistingColumnSelect()">
                    <option value="">-- S√©lectionner une colonne --</option>
                </select>
            </div>
            <div class="form-group">
                <label>Couleur de la colonne</label>
                <div class="color-picker" id="columnColorPicker"></div>
            </div>
            <div class="form-group">
                <label>Kanbans utilisant cette colonne (visualisation)</label>
                <div id="sectionTagsContainer" style="display:flex; flex-wrap:wrap; gap:8px; padding:10px; background:rgba(255,255,255,0.05); border-radius:8px; min-height:40px;"></div>
            </div>
            <button class="btn" onclick="saveColumn()">Enregistrer</button>
        </div>
    </div>
    <!-- Modal T√¢che -->
    <div class="modal" id="cardModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Ajouter/Modifier une t√¢che</h2>
                <span class="close-modal" onclick="closeModal('cardModal')">&times;</span>
            </div>
            <div class="form-group">
                <label>Titre</label>
                <input type="text" id="cardTitle" placeholder="Titre de la t√¢che">
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="cardDescription" placeholder="Description de la t√¢che"></textarea>
            </div>
            <div class="form-group">
                <label>Section</label>
                <select id="cardSection">
                    <option value="SOA">SOA</option>
                    <option value="SMSC">SMSC</option>
                    <option value="SOSC">SOSC</option>
                    <option value="SBO">SBO</option>
                    <option value="Transverse">Transverse</option>
                </select>
            </div>
            <div class="form-group">
                <label>Colonne</label>
                <select id="cardColumn"></select>
            </div>
            <div class="form-group">
                <label>Date d'√©ch√©ance</label>
                <input type="date" id="cardDueDate">
            </div>
            <div class="form-group">
                <label>Ressources (s√©parez par des virgules)</label>
                <input type="text" id="cardResources" placeholder="Ex: Jean Dupont, Marie Martin">
            </div>
            <div class="form-group">
                <label>√âtat d'avancement (%)</label>
                <input type="number" id="cardProgress" min="0" max="100" value="0">
            </div>
            <div class="form-group">
                <label>Priorit√©</label>
                <select id="cardPriority">
                    <option value="low">Basse</option>
                    <option value="medium">Moyenne</option>
                    <option value="high">Haute</option>
                </select>
            </div>
            <button class="btn" onclick="saveCard()">Enregistrer</button>
        </div>
    </div>

    <!-- Modal Param√®tres -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öôÔ∏è Param√®tres</h2>
                <span class="close-modal" onclick="closeModal('settingsModal')">&times;</span>
            </div>
            <div class="form-group">
                <button class="btn" onclick="openTitleModal()">üìù Modifier le titre</button>
            <button class="btn" onclick="openSectionsManagementModal()">üìã G√©rer les Sections</button>
            <button class="btn" onclick="openResourcesManagementModal()">üë• G√©rer les Ressources</button>
            <button class="btn" onclick="openTagsManagementModal()">üè∑Ô∏è G√©rer les Tags</button>
                <button class="btn" onclick="exportToPDF()">üì• Exporter en PDF</button>
                                    <button class="btn" onclick="exportData()">üì• Exporter les donn√©es (JSON)</button>
                    <button class="btn" onclick="importData()">üì§ Importer les donn√©es</button>
                <button class="btn btn-secondary" onclick="clearAllData()">üóëÔ∏è Effacer toutes les donn√©es</button>
                <button class="btn btn-secondary" onclick="resetApplication()" style="background: rgba(255,59,48,0.2); border-color: rgba(255,59,48,0.3);">‚ö†Ô∏è R√©initialiser totalement l'application</button>
            </div>
        </div>
    </div>

    <div class="modal" id="titleModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Modifier le titre de l'application</h2>
                <span class="close-modal" onclick="closeModal('titleModal')">&times;</span>
            </div>
            <div class="form-group">
                <label>Titre de l'application</label>
                <input type="text" id="appTitleInput" placeholder="Ex: üéØ Mon Kanban">
            </div>
            <button class="btn" onclick="saveAppTitle()">Enregistrer</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>

// Log sur cr√©ation colonne
function addColumnToSection(sectionId, colId) {
    let section = sections.find(s => s.id === sectionId);
    if (!section.columns.includes(colId)) {
        section.columns.push(colId);
        let order = getSectionOrder(sectionId);
        order.push(colId);
        saveSectionOrder(sectionId, order);
        console.log('[CREATION] Section:', sectionId, 'Colonne ajout√©e:', colId, 'Colonnes:', section.columns, 'Ordre:', order);
    }
    renderKanban(sectionId);
}
// Log sur suppression colonne
function removeColumnFromSection(sectionId, colId) {
    let section = sections.find(s => s.id === sectionId);
    if (!section) return;
    console.log('[SUPPRESSION] Section:', sectionId, 'Colonne supprim√©e:', colId, 'Avant:', section.columns);
    section.columns = section.columns.filter(id => id !== colId);
    let order = getSectionOrder(sectionId).filter(id => id !== colId);
    saveSectionOrder(sectionId, order);
    console.log('[SUPPRESSION] Apr√®s:', section.columns, 'Ordre:', order);
    renderKanban(sectionId);
}
// Log sur changement d'ordre drag/drop
function updateOrderAfterDrag(sectionId, newOrder) {
    console.log('[ORDRE] Drag/drop dans section:', sectionId, 'Nouvel ordre:', newOrder);
    saveSectionOrderSafe(sectionId, newOrder);
    renderKanban(sectionId);
}
// Log sur render
function renderKanban(sectionId) {
    const section = sections.find(sec => sec.id === sectionId);
    let order = getSectionOrderSafe(sectionId);
    let columns = getCurrentSectionColumns(sectionId);
    console.log('[RENDER] Section:', sectionId, 'Colonnes:', columns, 'Ordre:', order, 'Section.columns:', section.columns);
    // ...affiche les colonnes...
}
// Log sur sauvegarde ordre
function saveSectionOrderSafe(sectionId, orderArray) {
    let section = sections.find(s => s.id === sectionId);
    let realCols = section ? section.columns : [];
    let newOrder = orderArray.filter(id => realCols.includes(id));
    console.log('[SAVE-ORDER] Section:', sectionId, 'Ordre sauvegard√©:', newOrder, 'Section.columns:', realCols);
    saveSectionOrder(sectionId, newOrder);
}

function getSectionOrderSafe(sectionId) {
    let section = sections.find(s => s.id === sectionId);
    let realCols = section ? section.columns : [];
    let order = getSectionOrder(sectionId).filter(id => realCols.includes(id));
    let missing = realCols.filter(id => !order.includes(id));
    return order.concat(missing);
}
function saveSectionOrderSafe(sectionId, orderArray) {
    let section = sections.find(s => s.id === sectionId);
    let realCols = section ? section.columns : [];
    let newOrder = orderArray.filter(id => realCols.includes(id));
    saveSectionOrder(sectionId, newOrder);
}
function removeColumnFromSection(sectionId, colId) {
    let section = sections.find(s => s.id === sectionId);
    if (!section) return;
    section.columns = section.columns.filter(id => id !== colId);
    let order = getSectionOrder(sectionId).filter(id => id !== colId);
    saveSectionOrder(sectionId, order);
    renderKanban(sectionId);
}
function getCurrentSectionColumns(sectionId) {
    return getSectionOrderSafe(sectionId);
}
function populateColumnsSelect(sectionId, selectedColId) {
    const columnSelect = document.getElementById('taskColumn');
    if (!columnSelect) return;
    const cols = getCurrentSectionColumns(sectionId);
    columnSelect.innerHTML = '';
    cols.forEach((colId, i) => {
        let col = columns.find(c=>c.id===colId);
        if(!col) return;
        let opt = document.createElement('option');
        opt.value = col.id;
        opt.textContent = col.title;
        if((selectedColId && col.id===selectedColId) || (!selectedColId && i===0)) opt.selected=true;
        columnSelect.appendChild(opt);
    });
}
function openCardModalFromGlobal(sectionId) {
    document.getElementById('taskSection').value = sectionId;
    populateColumnsSelect(sectionId);
}
function openCardModalFromColumn(sectionId, colId) {
    document.getElementById('taskSection').value = sectionId;
    populateColumnsSelect(sectionId, colId);
}

function getCurrentSectionColumns(sectionId) {
    const section = sections.find(sec => sec.id === sectionId);
    if (!section) return [];
    let order = getSectionOrder(sectionId);
    let cols = section.columns.slice();
    if (order.length) cols.sort((a,b) => order.indexOf(a) - order.indexOf(b));
    return cols;
}
function populateColumnsSelect(sectionId, selectedColId) {
    const columnSelect = document.getElementById('taskColumn');
    if (!columnSelect) return;
    const cols = getCurrentSectionColumns(sectionId);
    columnSelect.innerHTML = '';
    cols.forEach((colId, i) => {
        let col = columns.find(c=>c.id===colId);
        if(!col) return;
        let opt = document.createElement('option');
        opt.value = col.id;
        opt.textContent = col.title;
        if((selectedColId && col.id===selectedColId) || (!selectedColId && i===0)) opt.selected=true;
        columnSelect.appendChild(opt);
    });
}
// ouverture modale ajout t√¢che global : pr√©remplissage section et colonne une
function openCardModalFromGlobal(sectionId) {
    document.getElementById('taskSection').value = sectionId;
    populateColumnsSelect(sectionId);
    // ... ouvrir modale ...
}
// ouverture modale ajout t√¢che sur colonne
function openCardModalFromColumn(sectionId, colId) {
    document.getElementById('taskSection').value = sectionId;
    populateColumnsSelect(sectionId, colId);
    // ... ouvrir modale ...
}

function saveSectionOrder(sectionId, orderArray) {
    localStorage.setItem('order_section_' + sectionId, JSON.stringify(orderArray));
}
function getSectionOrder(sectionId) {
    return JSON.parse(localStorage.getItem('order_section_' + sectionId) || '[]');
}

        // Palette de 30 couleurs
        const colorPalette = [
            '#0066cc', '#4ecca3', '#ffa500', '#ff6b9d', '#9b59b6',
            
            'rgba(255,149,0,0.3)', 'rgba(255,59,48,0.3)', 'rgba(255,204,0,0.3)',
            'rgba(52,199,89,0.3)', 'rgba(0,122,255,0.3)', 'rgba(88,86,214,0.3)',
            'rgba(175,82,222,0.3)', 'rgba(255,45,85,0.3)', 'rgba(255,99,164,0.3)',
            'rgba(255,179,71,0.3)', 'rgba(255,213,79,0.3)', 'rgba(158,216,107,0.3)',
            'rgba(102,212,207,0.3)', 'rgba(90,200,250,0.3)', 'rgba(64,156,255,0.3)',
            'rgba(125,122,255,0.3)', 'rgba(191,90,242,0.3)', 'rgba(255,55,95,0.3)',
            'rgba(255,115,87,0.3)', 'rgba(255,176,58,0.3)', 'rgba(240,240,240,0.25)',
            'rgba(220,220,255,0.25)', 'rgba(180,230,255,0.25)', 'rgba(200,255,230,0.25)',
            'rgba(255,220,200,0.25)', 'rgba(250,180,200,0.25)', 'rgba(210,210,255,0.25)',
            'rgba(190,250,190,0.25)', 'rgba(255,250,190,0.25)', 'rgba(255,200,255,0.25)'
        ];

        // Donn√©es
        let columns = JSON.parse(localStorage.getItem('kanbanColumns')) || [
            { id: 1, title: "√Ä faire", color: "rgba(100,149,237,0.3)", order: 0 },
            { id: 2, title: "En cours", color: "rgba(0,122,255,0.3)", order: 1 },
            { id: 3, title: "En r√©vision", color: "rgba(255,149,0,0.3)", order: 2 },
            { id: 4, title: "Termin√©", color: "rgba(52,199,89,0.3)", order: 3 }
        ];

        let cards = JSON.parse(localStorage.getItem('kanbanCards')) || [];
        let currentView = 'general';
        let currentEditingColumn = null;
        let currentEditingCard = null;
        let selectedColor = "rgba(100,149,237,0.3)";
        let currentContextColumn = null;
        let draggedCard = null;
        let draggedColumn = null;

        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            loadAppTitle();
            renderKanban();
            initializeColorPicker();
            setupDragAndDrop();
            
            // Fermer les menus au clic ext√©rieur
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.column-menu-container') && !e.target.closest('.card-menu-container')) {
                    document.querySelectorAll('.column-menu-dropdown, .card-menu-dropdown').forEach(menu => {
                        menu.classList.remove('show');
                    });
                }
            });
        });

        // Initialize color picker with palette
        function initializeColorPicker() {
            const picker = document.getElementById('columnColorPicker');
            picker.innerHTML = colorPalette.map(color =>
                `<div class="color-option" style="background: ${color}" data-color="${color}"></div>`
            ).join('');
            
            picker.querySelectorAll('.color-option').forEach(option => {
                option.addEventListener('click', () => {
                    selectedColor = option.dataset.color;
                    updateColorSelection();
                });
            });
        }

        // Toggle menus
        function toggleColumnMenu(columnId, event) {
            event.stopPropagation();
            const menu = document.getElementById(`column-menu-${columnId}`);
            
            // Fermer tous les autres menus
            document.querySelectorAll('.column-menu-dropdown, .card-menu-dropdown').forEach(m => {
                if (m !== menu) m.classList.remove('show');
            });
            
            menu.classList.toggle('show');
        }

        function toggleCardMenu(cardId, event) {
            event.stopPropagation();
            const menu = document.getElementById(`card-menu-${cardId}`);
            
            // Fermer tous les autres menus
            document.querySelectorAll('.column-menu-dropdown, .card-menu-dropdown').forEach(m => {
                if (m !== menu) m.classList.remove('show');
            });
            
            menu.classList.toggle('show');
        }

        // Rendu du Kanban
        function renderKanban() {
            const container = document.getElementById('kanbanContainer');
            container.innerHTML = '';

            let displayedColumns = [];
            const filterViews = ['allTasks', 'overdue', 'thisWeek', 'thisMonth'];

            if (currentView === 'general' || filterViews.includes(currentView)) {
                const columnsInSections = new Set();
                sections.forEach(section => {
                    if (section.columns) {
                        section.columns.forEach(colId => columnsInSections.add(colId));
                    }
                });

                const orphanColumns = columns.filter(col => !columnsInSections.has(col.id));
                const maxColumns = Math.max(...sections.map(s => s.columns ? s.columns.length : 0), 0);

                for (let i = 0; i < Math.max(maxColumns, orphanColumns.length); i++) {
                    if (i < orphanColumns.length) {
                        displayedColumns.push(orphanColumns[i]);
                    }

                    sections.forEach(section => {
                        if (section.columns && i < section.columns.length) {
                            const colId = section.columns[i];
                            const column = columns.find(c => c.id === colId);
                            if (column && !displayedColumns.find(c => c.id === colId)) {
                                displayedColumns.push(column);
                            }
                        }
                    });
                }
            } else {
                const viewLower = currentView.toLowerCase();
                const currentSection = sections.find(s => s.name.toLowerCase() === viewLower);
                
window.lastSectionId = currentSection ? currentSection.id : null;
if (currentSection && currentSection.columns) {
                    displayedColumns = currentSection.columns.map(colId => 
                        columns.find(c => c.id === colId)
                    ).filter(col => col !== undefined);
                }
            }

            displayedColumns.forEach(column => {
                const columnElement = createColumnElement(column);
                container.appendChild(columnElement);
            });

            updateColumnSelects();

        if (currentView !== 'general') {
            // Ajouter la colonne fictive "Ajouter une colonne"
        const addColumnPlaceholder = document.createElement('div');
        addColumnPlaceholder.className = 'add-column-placeholder';
        addColumnPlaceholder.onclick = () => openColumnModal();
        addColumnPlaceholder.innerHTML = `
            <div class="add-column-icon">+</div>
            <div class="add-column-text">Ajouter une colonne</div>
        `;
        container.appendChild(addColumnPlaceholder);
        }
        
        setupDragAndDrop();
        }

        // Cr√©er une colonne
        function createColumnElement(column, customCount) {
            const columnDiv = document.createElement('div');
            columnDiv.className = 'column';
            columnDiv.style.background = column.color || 'rgba(255,255,255,0.08)';
            columnDiv.dataset.columnId = column.id;
            columnDiv.draggable = true;

            const filteredCards = getFilteredCards(column.id);
            
            columnDiv.innerHTML = `
                <div class="column-header">
                    <div style="display: flex; align-items: center;">
                        <div class="column-title">${column.title}</div>
                        <span class="column-badge">${customCount !== undefined ? customCount : filteredCards.length}</span>
                    </div>
                    <div class="column-menu-container">
                        <button class="column-menu-btn" onclick="toggleColumnMenu(${column.id}, event)">‚ãÆ</button>
                        <div class="column-menu-dropdown" id="column-menu-${column.id}">
                            <button onclick="editColumn(${column.id})">‚úèÔ∏è Modifier</button>
                            <button onclick="deleteColumn(${column.id})">üóëÔ∏è Supprimer</button>
                        </div>
                    </div>
                </div>
                <button class="add-task-btn" onclick="openCardModalInContext(${column.id})"><span style="color: #f5f5f7;">+</span> Ajouter une t√¢che</button>
                <div class="cards-container" data-column-id="${column.id}">
                    ${filteredCards.map(card => createCardHTML(card)).join('')}
                </div>
            `;

            return columnDiv;
        }

        // Obtenir les cartes filtr√©es
        function getFilteredCards(columnId) {
            let filtered = cards.filter(card => card.columnId === columnId);
            
            if (currentView !== 'general') {
                filtered = filtered.filter(card =>
                    card.section.toLowerCase() === currentView.toLowerCase()
                );
            }

            return filtered;
        }

        // Cr√©er le HTML d'une carte
        function createCardHTML(card) {
            const dueDate = card.dueDate ? new Date(card.dueDate) : null;
            const isOverdue = dueDate && dueDate < new Date() && card.progress < 100;

            // Construit les m√©tadonn√©es (date et priorit√© en vertical)
            const metaItems = [];
            if (card.dueDate) metaItems.push(`<div>üìÖ ${formatDateDisplay(card.dueDate)}</div>`);
            if (card.priority) metaItems.push(`<div>${getPriorityIcon(card.priority)} ${getPriorityLabel(card.priority)}</div>`);
            const metaHtml = metaItems.length > 0 ? `<div class="card-meta">${metaItems.join('')}</div>` : '';

            // Ressources en mode texte
            const resourcesHtml = card.resources && card.resources.length > 0 
                ? `<div class="card-resources-text">üë§ ${card.resources.join(', ')}</div>` : '';

            return `
                <div class="card ${isOverdue ? 'overdue' : ''}" draggable="true" data-card-id="${card.id}">
                    <div class="card-header">
                        <div class="card-title-container">
                            <div class="card-title">${card.title}</div>
                            ${card.section && card.section.trim() ? (() => {
                                const section = sections.find(s => s.name.toLowerCase() === card.section.toLowerCase());
                                const bgColor = section ? section.color : 'rgba(100,149,237,0.3)';
                                return `<span class="card-section" style="background:${bgColor}; color:#f5f5f7;">${card.section}</span>`;
                            })() : ""}
                        </div>
                        <div class="card-menu-container">
                            <button class="card-menu-btn" onclick="toggleCardMenu(${card.id}, event)">‚ãÆ</button>
                            <div class="card-menu-dropdown" id="card-menu-${card.id}">
                                <button onclick="editCard(${card.id})">‚úèÔ∏è Modifier</button>
                                <button onclick="deleteCard(${card.id})">üóëÔ∏è Supprimer</button>
                            </div>
                        </div>
                    </div>
                    ${card.description ? `<div class="card-description">${card.description}</div>` : ''}
                    ${metaHtml}
                    ${resourcesHtml}
                    <div class="progress">
                        <div class="progress-fill" style="width: ${card.progress || 0}%">${card.progress || 0}%</div>
                    </div>
                </div>
            `;
        }

        // Gestion des vues
        
        function switchView(view) {
            currentView = view;

            // 1. Gestion des boutons avec couleur dynamique depuis data-section-color
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.remove('active');
                // Retirer les styles inline personnalis√©s
                btn.style.boxShadow = '';
                btn.style.borderColor = '';
            });

            // Ajouter la classe active au bouton cliqu√©
            if (typeof event !== 'undefined' && event.target) {
                event.target.classList.add('active');

                // R√©cup√©rer la couleur de la section depuis l'attribut data-section-color
                const sectionColor = event.target.getAttribute('data-section-color');

                if (sectionColor) {
                    // Appliquer la couleur pour le contour (border) et le halo (box-shadow)
                    const color = sectionColor;
                    // Convertir hex en rgba pour le box-shadow
                    const r = parseInt(color.slice(1,3), 16);
                    const g = parseInt(color.slice(3,5), 16);
                    const b = parseInt(color.slice(5,7), 16);

                    event.target.style.borderColor = color;
                    event.target.style.boxShadow = `0 4px 15px rgba(${r},${g},${b},0.4)`;
                }
            }

            // 2. Gestion intelligente Calendrier vs Kanban
            const calendarView = document.getElementById('calendarView');
            const isCalendarOpen = calendarView && (
                calendarView.classList.contains('show') ||
                (calendarView.style.display && calendarView.style.display !== 'none')
            );

            // 3. Mettre √† jour la vue appropri√©e
            if (isCalendarOpen) {
                renderCalendar();
            } else {
                renderKanban();
            }

            // 4. Sauvegarder la vue (sauf pour filtres temporaires)
            if (!['this-week', 'overdue', 'this-month'].includes(view)) {
                localStorage.setItem('currentView', view);
            }
        }


        // Filtres
        function showAllTasks() {
        // Cacher le calendrier et r√©afficher le kanban
        document.getElementById('calendarView').classList.remove('show');
        document.getElementById('kanbanContainer').style.display = 'flex';

        // Retirer l'√©tat actif de tous les boutons de filtre
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        renderKanban();
    }

        // Filtre les t√¢ches en retard selon la vue actuelle
        function filterOverdue() {
        // Cacher le calendrier et r√©afficher le kanban
        document.getElementById('calendarView').classList.remove('show');
        document.getElementById('kanbanContainer').style.display = 'flex';

        // G√©rer l'√©tat actif des boutons de filtre
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);

            let overdueCards = cards.filter(card => {
                const dueDate = card.dueDate ? new Date(card.dueDate) : null;
                return dueDate && dueDate < tomorrow && card.progress < 100;
            });

            if (currentView !== 'general') {
                overdueCards = overdueCards.filter(card => card.section.toLowerCase() === currentView.toLowerCase());
            }

            renderFilteredCards(overdueCards);
        }

        // Filtre les t√¢ches de cette semaine selon la vue actuelle
        function filterThisWeek() {
        // Cacher le calendrier et r√©afficher le kanban
        document.getElementById('calendarView').classList.remove('show');
        document.getElementById('kanbanContainer').style.display = 'flex';

        // G√©rer l'√©tat actif des boutons de filtre
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
            // Fonction pour obtenir le num√©ro de semaine ISO
            function getISOWeek(date) {
                const d = new Date(date);
                d.setHours(0, 0, 0, 0);
                // Jeudi de cette semaine
                d.setDate(d.getDate() + 4 - (d.getDay() || 7));
                // Premier jeudi de l'ann√©e
                const yearStart = new Date(d.getFullYear(), 0, 1);
                // Calculer le num√©ro de semaine
                const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
                return { year: d.getFullYear(), week: weekNo };
            }

            const today = new Date();
            const currentWeek = getISOWeek(today);

            let weekCards = cards.filter(card => {
                if (!card.dueDate) return false;
                const dueDate = new Date(card.dueDate);
                const taskWeek = getISOWeek(dueDate);

                // M√™me ann√©e ET m√™me num√©ro de semaine
                return taskWeek.year === currentWeek.year && taskWeek.week === currentWeek.week;
            });

            // Applique le filtre de section
            if (currentView !== 'general') {
                weekCards = weekCards.filter(card => card.section.toLowerCase() === currentView.toLowerCase());
            }

            renderFilteredCards(weekCards);
        }

        // Filtre les t√¢ches de ce mois selon la vue actuelle
        function filterThisMonth() {
        // Cacher le calendrier et r√©afficher le kanban
        document.getElementById('calendarView').classList.remove('show');
        document.getElementById('kanbanContainer').style.display = 'flex';

        // G√©rer l'√©tat actif des boutons de filtre
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
            const today = new Date();
            const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 1);

            let monthCards = cards.filter(card => {
                const dueDate = card.dueDate ? new Date(card.dueDate) : null;
                return dueDate && dueDate >= startOfMonth && dueDate < endOfMonth;
            });

            if (currentView !== 'general') {
                monthCards = monthCards.filter(card => card.section.toLowerCase() === currentView.toLowerCase());
            }

            renderFilteredCards(monthCards);
        }

        function renderFilteredCards(filteredCards) {
            const kanbanContainer = document.getElementById('kanbanContainer');
            kanbanContainer.innerHTML = '';

            // D√©terminer les colonnes √† afficher selon la vue actuelle
            let displayedColumns = [];

            if (currentView === 'general') {
                // M√äME LOGIQUE QUE renderKanban pour vue g√©n√©ral (interleaving sans tri)
                const columnsInSections = new Set();
                sections.forEach(section => {
                    if (section.columns) {
                        section.columns.forEach(colId => columnsInSections.add(colId));
                    }
                });

                const orphanColumns = columns.filter(col => !columnsInSections.has(col.id));
                const maxColumns = Math.max(...sections.map(s => s.columns ? s.columns.length : 0), 0);

                for (let i = 0; i < Math.max(maxColumns, orphanColumns.length); i++) {
                    if (i < orphanColumns.length) {
                        displayedColumns.push(orphanColumns[i]);
                    }

                    sections.forEach(section => {
                        if (section.columns && i < section.columns.length) {
                            const colId = section.columns[i];
                            const column = columns.find(c => c.id === colId);
                            // Anti-doublon (comme renderKanban)
                            if (column && !displayedColumns.find(c => c.id === colId)) {
                                displayedColumns.push(column);
                            }
                        }
                    });
                }
            } else {
                // Dans une vue de section, afficher TOUTES les colonnes de cette section (m√™me vides)
                const viewLower = currentView.toLowerCase();
                const currentSection = sections.find(s => s.name.toLowerCase() === viewLower);

                window.lastSectionId = currentSection ? currentSection.id : null;
                if (currentSection && currentSection.columns) {
                    displayedColumns = currentSection.columns.map(colId => 
                        columns.find(c => c.id === colId)
                    ).filter(col => col !== undefined);
                }
            }

            // Afficher les colonnes avec les cartes filtr√©es (PAS DE TRI!)
            displayedColumns.forEach(column => {
                const columnCards = filteredCards.filter(card => card.columnId === column.id);
                const columnDiv = createColumnElement(column, columnCards.length);
                columnDiv.style.background = column.color || 'rgba(255,255,255,0.08)';
                const cardsContainer = columnDiv.querySelector('.cards-container');
                cardsContainer.innerHTML = columnCards.map(card => createCardHTML(card)).join('');
                kanbanContainer.appendChild(columnDiv);
            });

        // Ajouter la colonne fictive "Ajouter une colonne"
        const addColumnPlaceholder = document.createElement('div');
        addColumnPlaceholder.className = 'add-column-placeholder';
        addColumnPlaceholder.onclick = () => openColumnModal();
        addColumnPlaceholder.innerHTML = `
            <div class="add-column-icon">+</div>
            <div class="add-column-text">Ajouter une colonne</div>
        `;
        kanbanContainer.appendChild(addColumnPlaceholder);
        
        setupDragAndDrop();
        }

        // Calendrier
        // Affiche le calendrier filtr√© selon la vue actuelle
        function showCalendar() {
            // Retirer l'√©tat actif de tous les boutons de filtre
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));

            document.getElementById('kanbanContainer').style.display = 'none';
            document.getElementById('calendarView').classList.add('show');
            renderCalendar();
        }

        let currentDetailCardId = null;

        function showTaskDetail(cardId, event) {
            const card = cards.find(c => c.id === cardId);
            if (!card) return;
            currentDetailCardId = cardId;
            document.getElementById('detailTitle').textContent = card.title;
            const sectionEl = document.getElementById('detailSection');
            if (card.section && card.section.trim()) {
                const section = sections.find(s => s.name.toLowerCase() === card.section.toLowerCase());
                const bgColor = section ? section.color : 'rgba(100,149,237,0.3)';
                sectionEl.textContent = card.section;
                sectionEl.style.background = bgColor;
                sectionEl.style.color = '#f5f5f7';
                sectionEl.style.display = 'inline-block';
            } else {
                sectionEl.style.display = 'none';
            }
            const descEl = document.getElementById('detailDescription');
            if (card.description && card.description.trim()) { descEl.textContent = card.description; descEl.style.display = 'block'; } else { descEl.style.display = 'none'; }
            const metaItems = [];
            if (card.dueDate) metaItems.push('<div class="calendar-task-detail-meta-item">üìÖ ' + formatDateDisplay(card.dueDate) + '</div>');
            if (card.priority) metaItems.push('<div class="calendar-task-detail-meta-item">' + getPriorityIcon(card.priority) + ' ' + getPriorityLabel(card.priority) + '</div>');
            if (card.resources && card.resources.length > 0) metaItems.push('<div class="calendar-task-detail-meta-item">üë§ ' + card.resources.join(', ') + '</div>');
            const metaEl = document.getElementById('detailMeta');
            metaEl.innerHTML = metaItems.join(''); metaEl.style.display = metaItems.length > 0 ? 'flex' : 'none';
            const progressContainer = document.getElementById('detailProgressContainer');
            const progress = card.progress || 0;
            if (progress > 0) { const progressEl = document.getElementById('detailProgress'); progressEl.style.width = progress + '%'; progressEl.textContent = progress + '%'; progressContainer.style.display = 'block'; } else { progressContainer.style.display = 'none'; }
            const bubble = document.getElementById('calendarTaskDetail');
            let left = event.pageX + 20, top = event.pageY;
            if (left + 350 > window.innerWidth) left = event.pageX - 370;
            bubble.style.left = left + 'px'; bubble.style.top = top + 'px'; bubble.classList.add('show');
        }

        function closeTaskDetail() { document.getElementById('calendarTaskDetail').classList.remove('show'); document.getElementById('detailMenu').classList.remove('show'); currentDetailCardId = null; }
        function toggleDetailMenu(event) { event.stopPropagation(); document.getElementById('detailMenu').classList.toggle('show'); }
        function editCardFromDetail() { if (currentDetailCardId !== null) { const id = currentDetailCardId; closeTaskDetail(); editCard(id); } }
        function deleteCardFromDetail() { if (currentDetailCardId !== null) { const id = currentDetailCardId; closeTaskDetail(); deleteCard(id); } }

        function renderCalendar_OLD() {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';

            const today = new Date();
            const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(today.getFullYear(), today.getMonth(), day);

                // Filtre les cartes pour ce jour
                let dayCards = cards.filter(card => {
                    if (!card.dueDate) return false;
                    const cardDate = new Date(card.dueDate);
                    return cardDate.getDate() === day &&
                           cardDate.getMonth() === today.getMonth() &&
                           cardDate.getFullYear() === today.getFullYear();
                });

                // Applique le filtre de section si pas en vue g√©n√©rale
                if (currentView !== 'general') {
                    dayCards = dayCards.filter(card =>
                        card.section.toLowerCase() === currentView.toLowerCase()
                    );
                }

                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day';
                dayDiv.innerHTML = `
                    <div class="calendar-day-header">${day} ${date.toLocaleDateString('fr-FR', { weekday: 'short' })}</div>
                    
                ${dayCards.map(card => {
                    const section = sections.find(s => s.name.toLowerCase() === card.section.toLowerCase());
                    const bgColor = section ? section.color : 'rgba(100,149,237,0.3)';
                    const sectionText = card.section && card.section.trim() ? ` - ${card.section}` : '';
                    return `<div class="calendar-task" style="background:${bgColor}; border-left-color:${bgColor}; color:#f5f5f7;" onclick="showTaskDetail(${card.id}, event)">${card.title}${sectionText}</div>`;
                }).join('')}

                `;
                grid.appendChild(dayDiv);
            }
        }

        function displaySectionTags(sectionsToDisplay) {
            const container = document.getElementById('sectionTagsContainer');
            if (!container) return;
            
            container.innerHTML = sectionsToDisplay.map(sectionId => {
                const section = sections.find(s => s.id === sectionId);
                if (!section) return '';
                return `<div style="display:inline-flex; align-items:center; gap:6px; padding:6px 12px; background:${section.color}; border-radius:20px; color:white; font-weight:500; font-size:0.9rem;">${section.name}</div>`;
            }).join('');
        }
        function handleExistingColumnSelect() {
            const select = document.getElementById('existingColumnSelect');
            const titleInput = document.getElementById('columnTitle');
            const colorPicker = document.getElementById('columnColorPicker');
            const columnId = parseInt(select.value);

            if (columnId && !isNaN(columnId)) {
                const column = columns.find(c => c.id === columnId);
                if (column) {
                    titleInput.value = column.title;
                    titleInput.disabled = true;
                    titleInput.style.opacity = '0.5';
                    titleInput.style.cursor = 'not-allowed';
                    titleInput.style.background = 'rgba(100,100,100,0.3)';
                    selectedColor = column.color;
                    updateColorSelection();
                    colorPicker.style.opacity = '0.5';
                    colorPicker.style.pointerEvents = 'none';

                    const usingSections = sections.filter(s => s.columns && s.columns.includes(columnId)).map(s => s.id);
                    if (currentView !== 'general') {
                        const viewLower = currentView.toLowerCase();
                        const currentSection = sections.find(s => s.name.toLowerCase() === viewLower);
                        
window.lastSectionId = currentSection ? currentSection.id : null;
if (currentSection && !usingSections.includes(currentSection.id)) {
                            usingSections.push(currentSection.id);
                        }
                    }
                    displaySectionTags(usingSections);
                }
            } else {
                titleInput.disabled = false;
                titleInput.style.opacity = '1';
                titleInput.style.cursor = 'text';
                titleInput.style.background = '';
                colorPicker.style.opacity = '1';
                colorPicker.style.pointerEvents = 'auto';

                const sectionsToShow = [];
                if (currentView !== 'general') {
                    const viewLower = currentView.toLowerCase();
                    const currentSection = sections.find(s => s.name.toLowerCase() === viewLower);
                    
window.lastSectionId = currentSection ? currentSection.id : null;
if (currentSection) sectionsToShow.push(currentSection.id);
                }
                displaySectionTags(sectionsToShow);
            }
        }

        function populateExistingColumnSelect() {
            const select = document.getElementById('existingColumnSelect');
            if (!select) return;
            
            // Nettoyer les options existantes
            while (select.firstChild) {
                select.removeChild(select.firstChild);
            }
            
            // Ajouter l'option par d√©faut
            let options = '<option value="">-- S√©lectionner une colonne --</option>';
            
            // Ajouter les colonnes disponibles
            if (columns && columns.length) {
                columns.forEach(col => {
                    options += `<option value="${col.id}">${col.title}</option>`;
                });
            }
            
            select.innerHTML = options;
        }
        function openColumnModal(columnId = null) {
            currentEditingColumn = columnId;
            const modal = document.getElementById('columnModal');
            const existingColumnGroup = document.getElementById('existingColumnGroup');
            const titleInput = document.getElementById('columnTitle');
            const colorPicker = document.getElementById('columnColorPicker');

            if (columnId) {
                // Mode MODIFICATION : masquer le menu d√©roulant des colonnes existantes
                if (existingColumnGroup) {
                    existingColumnGroup.style.display = 'none';
                }

                const column = columns.find(c => c.id === columnId);

                // D√âVERROUILLER les champs pour permettre la modification
                titleInput.disabled = false;
                titleInput.style.opacity = '1';
                titleInput.style.cursor = 'text';
                titleInput.style.background = '';
                colorPicker.style.opacity = '1';
                colorPicker.style.pointerEvents = 'auto';

                // Remplir avec les valeurs de la colonne
                titleInput.value = column.title;
                selectedColor = column.color;

                // Trouver et afficher les sections utilisant cette colonne
                const usingSections = sections.filter(s => s.columns && s.columns.includes(columnId)).map(s => s.id);
                displaySectionTags(usingSections);
            } else {
                // Mode CR√âATION : afficher le menu d√©roulant des colonnes existantes
                if (existingColumnGroup) {
                    existingColumnGroup.style.display = 'block';
                }

                // Populer le menu d√©roulant des colonnes existantes
                populateExistingColumnSelect();

                // D√âVERROUILLER les champs pour permettre la cr√©ation
                titleInput.disabled = false;
                titleInput.style.opacity = '1';
                titleInput.style.cursor = 'text';
                titleInput.style.background = '';
                colorPicker.style.opacity = '1';
                colorPicker.style.pointerEvents = 'auto';

                // Vider les champs
                titleInput.value = '';
                selectedColor = "rgba(100,149,237,0.3)";

                // Si on est dans une vue de section, afficher cette section
                const sectionsToShow = [];
                if (currentView !== 'general') {
                    const viewLower = currentView.toLowerCase();
                    const currentSection = sections.find(s => s.name.toLowerCase() === viewLower);
                    
window.lastSectionId = currentSection ? currentSection.id : null;
if (currentSection) sectionsToShow.push(currentSection.id);
                }
                displaySectionTags(sectionsToShow);
            }

            updateColorSelection();
            modal.classList.add('show');
        }
        
        function openCardModal(columnId = null, cardId = null) {
            currentEditingCard = cardId;
            currentContextColumn = columnId;
            const modal = document.getElementById('cardModal');

            // S√©curit√© : si modalTitle n'existe pas (anciens fichiers), on l'ignore silencieusement
            const titleEl = document.getElementById('modalTitle');

            // 1. Mettre √† jour la liste des sections
            const sectionSelect = document.getElementById('cardSection');
            if (sectionSelect) {
                sectionSelect.innerHTML = '';
                sections.forEach(sec => {
                    const opt = document.createElement('option');
                    opt.value = sec.name;
                    opt.textContent = sec.name;
                    sectionSelect.appendChild(opt);
                });
            }

            if (cardId !== null && cardId !== undefined) {
                // MODE MODIFICATION
                if (titleEl) titleEl.textContent = 'Modifier la t√¢che';
                const card = cards.find(c => c.id === cardId);

                if (card) {
                    if(document.getElementById('cardTitle')) document.getElementById('cardTitle').value = card.title;
                    if(document.getElementById('cardDescription')) document.getElementById('cardDescription').value = card.description || '';

                    if (sectionSelect) {
                        // Gestion Section (casse-insensitive)
                        let sectionToSelect = card.section;
                        let optionExists = Array.from(sectionSelect.options).some(o => o.value === sectionToSelect);
                        if (!optionExists) {
                            if (Array.from(sectionSelect.options).some(o => o.value === sectionToSelect.toUpperCase())) {
                                sectionToSelect = sectionToSelect.toUpperCase();
                            }
                        }
                        sectionSelect.value = sectionToSelect;

                        // IMPORTANT : Mettre √† jour les colonnes imm√©diatement
                        updateColumnSelect(sectionToSelect);
                    }

                    // S√©lectionner la colonne (apr√®s updateColumnSelect)
                    if(document.getElementById('cardColumn')) document.getElementById('cardColumn').value = card.columnId;

                    if(document.getElementById('cardDueDate')) document.getElementById('cardDueDate').value = card.dueDate || '';
                    if(document.getElementById('cardResources')) document.getElementById('cardResources').value = card.resources ? card.resources.join(', ') : '';
                    if(document.getElementById('cardProgress')) document.getElementById('cardProgress').value = card.progress || 0;
                    if(document.getElementById('cardPriority')) document.getElementById('cardPriority').value = card.priority || 'low';
                }
            } else {
                // MODE CR√âATION
                if (titleEl) titleEl.textContent = 'Nouvelle t√¢che';
                if(document.getElementById('cardTitle')) document.getElementById('cardTitle').value = '';
                if(document.getElementById('cardDescription')) document.getElementById('cardDescription').value = '';
                if(document.getElementById('cardDueDate')) document.getElementById('cardDueDate').value = '';
                if(document.getElementById('cardResources')) document.getElementById('cardResources').value = '';
                if(document.getElementById('cardProgress')) document.getElementById('cardProgress').value = 0;
                if(document.getElementById('cardPriority')) document.getElementById('cardPriority').value = 'low';

                if (sectionSelect) {
                    // Section par d√©faut
                    let defaultSection = 'SOA';
                    if (typeof currentView !== 'undefined' && currentView !== 'general') {
                        const matchingSec = sections.find(s => s.name.toLowerCase() === currentView.toLowerCase());
                        if (matchingSec) defaultSection = matchingSec.name;
                    }
                    sectionSelect.value = defaultSection;
                    updateColumnSelect(defaultSection);
                }

                if(document.getElementById('cardColumn')) {
                    if (columnId) {
                        document.getElementById('cardColumn').value = columnId;
                    } else {
                         const colSelect = document.getElementById('cardColumn');
                         if (colSelect.options.length > 0) colSelect.selectedIndex = 0;
                    }
                }
            }
            if (modal) openModal('cardModal');
        }

        function updateColumnSelect(sectionName) {
            const columnSelect = document.getElementById('cardColumn');
            if (!columnSelect) return;

            columnSelect.innerHTML = '';
            const section = sections.find(s => s.name === sectionName);
            if (!section) return;

            const sectionColumns = [];
            if (section.columns && section.columns.length > 0) {
                 section.columns.forEach(colId => {
                     const col = columns.find(c => c.id === colId);
                     if (col) sectionColumns.push(col);
                 });
            }

            sectionColumns.forEach(col => {
                const opt = document.createElement('option');
                opt.value = col.id;
                opt.textContent = col.title;
                columnSelect.appendChild(opt);
            });
        }


        function openCardModalInContext(columnId) {
        openCardModal(columnId, null);

        // Si on est dans une vue de section, pr√©-remplir la section
        if (currentView !== 'general') {
            const sectionSelect = document.getElementById('cardSection');
            if (sectionSelect) {
                // Trouver la section correspondant √† la vue actuelle
                const section = sections.find(s => s.name.toLowerCase() === currentView.toLowerCase());

                if (section) {
                    sectionSelect.value = section.name;
                    // Mettre √† jour les colonnes disponibles selon la section
                    updateColumnSelects();

                    // Re-s√©lectionner la colonne apr√®s le filtre
                    const columnSelect = document.getElementById('cardColumn');
                    if (columnSelect && columnId) {
                        columnSelect.value = columnId;
                    }
                }
            }
        }
    }

        function toggleSettingsMenu() { openSettingsModal(); }

        function openSettingsModal() {
            document.getElementById('settingsModal').classList.add('show');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        // Sauvegarder colonne
        function saveColumn() {
            const title = document.getElementById('columnTitle').value.trim();
            const existingColumnSelect = document.getElementById('existingColumnSelect');
            const selectedExistingId = existingColumnSelect ? parseInt(existingColumnSelect.value) : null;

            // Si une colonne existante est s√©lectionn√©e dans le menu d√©roulant
            if (selectedExistingId && !isNaN(selectedExistingId)) {
                // Utiliser la colonne existante et l'associer √† la section actuelle
                if (currentView !== 'general') {
                    const viewLower = currentView.toLowerCase();
                    const currentSection = sections.find(s => s.name.toLowerCase() === viewLower);

window.lastSectionId = currentSection ? currentSection.id : null;
if (currentSection) {
                        // Initialiser columns si elle n'existe pas
                        if (!currentSection.columns) {
                            currentSection.columns = [];
                        }

                        // V√©rifier si la colonne n'est pas d√©j√† dans la section
                        if (!currentSection.columns.includes(selectedExistingId)) {
                            currentSection.columns.push(selectedExistingId);
                            saveSections();
                        }
                    }
                }

                saveToLocalStorage();
                renderKanban();
                closeModal('columnModal');
                return;
            }

            // Sinon, cr√©er une nouvelle colonne ou modifier l'existante
            if (!title) {
                alert('Veuillez entrer un titre pour la colonne');
                return;
            }

            if (currentEditingColumn) {
                // Modification d'une colonne existante
                const column = columns.find(c => c.id === currentEditingColumn);
                column.title = title;
                column.color = selectedColor;
            } else {
                // Cr√©ation d'une nouvelle colonne
                const newColumn = {
                    id: Date.now(),
                    title: title,
                    color: selectedColor,
                    order: columns.length
                };
                columns.push(newColumn);

                // Si on est dans une vue de section, associer automatiquement la nouvelle colonne
                if (currentView !== 'general') {
                    const viewLower = currentView.toLowerCase();
                    const currentSection = sections.find(s => s.name.toLowerCase() === viewLower);

window.lastSectionId = currentSection ? currentSection.id : null;
if (currentSection) {
                        // Initialiser columns si elle n'existe pas
                        if (!currentSection.columns) {
                            currentSection.columns = [];
                        }

                        currentSection.columns.push(newColumn.id);
                        saveSections();
                    }
                }
            }

            saveToLocalStorage();
            renderKanban();
            if(typeof renderCalendar === 'function') renderCalendar();
            closeModal('columnModal');
        }
        // Sauvegarder carte
        function saveCard() {
            const title = document.getElementById('cardTitle').value.trim();
            const description = document.getElementById('cardDescription').value.trim();
            const section = document.getElementById('cardSection').value;
            const columnId = parseInt(document.getElementById('cardColumn').value);
            const dueDate = document.getElementById('cardDueDate').value;
            const resources = document.getElementById('cardResources').value.split(',').map(r => r.trim()).filter(r => r);
            const progress = parseInt(document.getElementById('cardProgress').value) || 0;
            const priority = document.getElementById('cardPriority').value;

            if (!title) {
                alert('Veuillez entrer un titre pour la t√¢che');
                return;
            }

            // Validation section/colonne
            if (section) {
                const sec = sections.find(s => s.name === section);
                const allowed = sec && Array.isArray(sec.columns) ? sec.columns : [];
                if (!allowed || allowed.length === 0) {
                    alert("Cette section ne contient aucune colonne. Ajoutez des colonnes √† la section avant d'y affecter une t√¢che.");
                    return;
                }
                if (!allowed.includes(columnId)) {
                    alert("Cette colonne n'existe pas dans le kanban de la section s√©lectionn√©e.");
                    return;
                }
            }

            if (currentEditingCard) {
                const card = cards.find(c => c.id === currentEditingCard);
                card.title = title;
                card.description = description;
                card.section = section;
                card.columnId = columnId;
                card.dueDate = dueDate;
                card.resources = resources;
                card.progress = progress;
                card.priority = priority;
                card.lastUpdated = new Date().getTime();
            } else {
                const newCard = {
                    id: Date.now(),
                    title,
                    description,
                    section,
                    columnId: currentContextColumn || columnId,
                    dueDate,
                    resources,
                    progress,
                    priority,
                    lastUpdated: new Date().getTime()
                };
                cards.push(newCard);
            }

            saveToLocalStorage();
            renderKanban();
            if(typeof renderCalendar === 'function') renderCalendar();
            if(typeof renderCalendar === "function") renderCalendar();
            closeModal('cardModal');
        }

        // √âditer et supprimer
        function editColumn(columnId) {
            openColumnModal(columnId);
        }

        function deleteColumn(columnId) {
            const column = columns.find(c => c.id === columnId);
            if (!column) return;

            const usingSections = sections.filter(s => s.columns && s.columns.includes(columnId));
            const tasksInColumn = cards.filter(c => c.columnId === columnId);

            if (currentView === 'general') {
                if (usingSections.length > 0) {
                    const sectionNames = usingSections.map(s => s.name).join(', ');
                    alert(`Impossible de supprimer cette colonne !

Cette colonne est utilis√©e par : ${sectionNames}

Retirer la colonne de chaque section avant de la supprimer.`);
                    return;
                }

                if (tasksInColumn.length > 0) {
                    const confirmMsg = `ATTENTION : SUPPRESSION D√âFINITIVE

Cette colonne "${column.title}" contient ${tasksInColumn.length} t√¢che(s).

La suppression entra√Ænera la SUPPRESSION D√âFINITIVE de toutes ces t√¢ches.

Continuer ?`;
                    if (!confirm(confirmMsg)) return;
                }

                columns = columns.filter(c => c.id !== columnId);
                cards = cards.filter(c => c.columnId !== columnId);
                saveToLocalStorage();
                renderKanban();

            } else {
                const viewLower = currentView.toLowerCase();
                const currentSection = sections.find(s => s.name.toLowerCase() === viewLower);
                
window.lastSectionId = currentSection ? currentSection.id : null;
if (!currentSection || !currentSection.columns) return;

                const otherSectionsUsingColumn = usingSections.filter(s => s.id !== currentSection.id);
                const willBeOrphan = otherSectionsUsingColumn.length === 0;
                const hasNoTasks = tasksInColumn.length === 0;

                if (willBeOrphan && hasNoTasks) {
                    const confirmMsg = `Suppression d√©finitive

La colonne "${column.title}" n'est utilis√©e nulle part ailleurs et ne contient aucune t√¢che.

Elle sera SUPPRIM√âE D√âFINITIVEMENT.

Continuer ?`;
                    if (!confirm(confirmMsg)) return;

                    currentSection.columns = currentSection.columns.filter(id => id !== columnId);
                    saveSections();
                    columns = columns.filter(c => c.id !== columnId);
                    saveToLocalStorage();
                    renderKanban();

                } else {
                    let reason = '';
                    if (!willBeOrphan) {
                        const otherNames = otherSectionsUsingColumn.map(s => s.name).join(', ');
                        reason = `utilis√©e dans : ${otherNames}`;
                    }
                    if (!hasNoTasks) {
                        if (reason) reason += ' et ';
                        reason += `contient ${tasksInColumn.length} t√¢che(s)`;
                    }

                    const confirmMsg = `Retrait de la section

La colonne "${column.title}" sera retir√©e de cette section uniquement.

Elle sera conserv√©e car elle est ${reason}.

Continuer ?`;
                    if (!confirm(confirmMsg)) return;

                    currentSection.columns = currentSection.columns.filter(id => id !== columnId);
                    saveSections();
                    renderKanban();
                }
            }
        }

        function editCard(cardId) {
            openCardModal(null, cardId);
        }

        function deleteCard(cardId) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cette t√¢che ?')) {
                cards = cards.filter(c => c.id !== cardId);
                saveToLocalStorage();
                renderKanban();
                if(typeof renderCalendar === "function") renderCalendar();
            }
        }

        // Drag and Drop - Cards and Columns

        // Configure tous les √©v√©nements de drag and drop
        function setupDragAndDrop() {
            const cardElements = document.querySelectorAll('.card');
            const containers = document.querySelectorAll('.cards-container');
            const columnElements = document.querySelectorAll('.column');

            // Configure le drag des cartes
            cardElements.forEach(card => {
                card.addEventListener('dragstart', handleCardDragStart);
                card.addEventListener('dragend', handleCardDragEnd);
            });

            // Configure le drop dans les conteneurs de cartes
            containers.forEach(container => {
                container.addEventListener('dragover', handleCardDragOver);
                container.addEventListener('drop', handleCardDrop);
                container.addEventListener('dragleave', handleCardDragLeave);
            });

            // Configure le drag des colonnes
            columnElements.forEach(column => {
                setupColumnDrag(column);
            });
        }

        // ===== DRAG AND DROP DES CARTES =====

        // G√®re le d√©but du drag d'une carte
        function handleCardDragStart(e) {
            draggedCard = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.stopPropagation();
        }

        // G√®re la fin du drag d'une carte
        function handleCardDragEnd(e) {
            this.classList.remove('dragging');
            this.style.opacity = '1';
        }

        // G√®re le survol lors du drag d'une carte
        function handleCardDragOver(e) {
            if (draggedCard) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';

                // Trouve l'√©l√©ment apr√®s lequel ins√©rer
                const afterElement = getDragAfterElementCard(this, e.clientY);

                if (afterElement == null) {
                    this.appendChild(draggedCard);
                } else {
                    this.insertBefore(draggedCard, afterElement);
                }

                e.stopPropagation();
            }
        }

        // G√®re la sortie lors du drag d'une carte
        function handleCardDragLeave(e) {
            // Vide pour le moment
        }

        // G√®re le drop d'une carte
        function handleCardDrop(e) {
            if (draggedCard) {
                e.stopPropagation();
                e.preventDefault();

                const cardId = parseInt(draggedCard.dataset.cardId);
                const newColumnId = parseInt(this.dataset.columnId);

                const card = cards.find(c => c.id === cardId);
                if (card) {
                    if (currentView === 'general' && card.section) {
                        const sec = sections.find(s => s.name === card.section);
                        if (sec && Array.isArray(sec.columns) && sec.columns.length > 0) {
                            if (!sec.columns.includes(newColumnId)) {
                                console.warn('D√©placement interdit: colonne non pr√©sente dans la section', card.section, 'colId:', newColumnId);
                                renderKanban();
                                draggedCard = null;
                                return;
                            }
                        }
                    }

                    card.columnId = newColumnId;
                    card.lastUpdated = new Date().getTime();

                    const cardElements = Array.from(this.querySelectorAll('.card'));
                    const orderedIds = cardElements.map(el => parseInt(el.dataset.cardId));

                    const columnCards = cards.filter(c => c.columnId === newColumnId);
                    const orderedCards = [];
                    orderedIds.forEach(id => {
                        const c = columnCards.find(card => card.id === id);
                        if (c) orderedCards.push(c);
                    });

                    cards = cards.filter(c => c.columnId !== newColumnId).concat(orderedCards);

                    saveToLocalStorage();
                    renderKanban();
                }

                draggedCard = null;
            }
        }

        // Calcule la position d'insertion d'une carte pendant le drag
        function getDragAfterElementCard(container, y) {
            const draggableElements = [...container.querySelectorAll('.card:not(.dragging)')];

            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;

                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // ===== DRAG AND DROP DES COLONNES =====

        // Configure le drag d'une colonne
        function setupColumnDrag(columnElement) {
            columnElement.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('text/plain', columnElement.dataset.columnId);
                columnElement.classList.add('dragging-column');
            });

            columnElement.addEventListener('dragend', () => {
                columnElement.classList.remove('dragging-column');

                // Sauvegarde uniquement l'ordre des colonnes de la section courante (quand on est sur une section)
                if (currentView !== 'general') {
                    const currentSection = sections.find(s => s.name.toLowerCase() === currentView.toLowerCase());
                    if (!currentSection) {
                        console.warn('[COL-ORDER] Section courante introuvable, ordre non sauvegard√©');
                        return;
                    }

                    const container = document.getElementById('kanbanContainer');
                    const cols = Array.from(container.querySelectorAll('.column')).map(el => parseInt(el.dataset.columnId));
                    const newOrder = cols.filter(id => currentSection.columns && currentSection.columns.includes(id));

                    currentSection.columns = newOrder;
                    saveSections();
                    saveSectionOrderSafe(currentSection.id, newOrder);
                    console.log('[COL-ORDER] Nouvel ordre colonne (section):', currentSection.name, newOrder);
                    renderKanban();
                }
            });

            columnElement.addEventListener('dragover', (e) => {
                e.preventDefault();
                const dragging = document.querySelector('.dragging-column');
                if (!dragging || dragging === columnElement) return;

                const container = document.getElementById('kanbanContainer');
                const columnsList = Array.from(container.querySelectorAll('.column'));
                const draggingIndex = columnsList.indexOf(dragging);
                const targetIndex = columnsList.indexOf(columnElement);

                if (draggingIndex < targetIndex) {
                    container.insertBefore(dragging, columnElement.nextSibling);
                } else {
                    container.insertBefore(dragging, columnElement);
                }
            });
        }

        // Calcule la position d'insertion d'une colonne pendant le drag
        function getDragAfterElementColumn(container, x) {
            const draggableElements = [...container.querySelectorAll('.column:not(.dragging-column)')];

            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = x - box.left - box.width / 2;

                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // Color Picker
        function updateColorSelection() {
            document.querySelectorAll('.color-option').forEach(option => {
                option.classList.remove('selected');
                if (option.dataset.color === selectedColor) {
                    option.classList.add('selected');
                }
            });
        }

        // Utilitaires
        function updateColumnSelects() {
            const sectionSelect = document.getElementById('cardSection');
            const sectionName = sectionSelect ? sectionSelect.value : '';
            const columnSelect = document.getElementById('cardColumn');
            if (!columnSelect) return;

            const previousValue = columnSelect.value;
            columnSelect.innerHTML = '';
            columnSelect.disabled = false;

            if (!sectionName) {
                columns
                    .slice()
                    .sort((a, b) => {
                        const ao = (a.order !== undefined && a.order !== null) ? a.order : 9999;
                        const bo = (b.order !== undefined && b.order !== null) ? b.order : 9999;
                        return ao - bo;
                    })
                    .forEach(col => {
                        const opt = document.createElement('option');
                        opt.value = col.id;
                        opt.textContent = col.title;
                        columnSelect.appendChild(opt);
                    });

                if (previousValue) columnSelect.value = previousValue;
                return;
            }

            const section = sections.find(s => s.name === sectionName);
            const allowedIds = section && Array.isArray(section.columns) ? section.columns.slice() : [];

            if (!allowedIds.length) {
                const opt = document.createElement('option');
                opt.value = '';
                opt.textContent = 'Aucune colonne pour cette section';
                columnSelect.appendChild(opt);
                columnSelect.value = '';
                columnSelect.disabled = true;
                return;
            }

            allowedIds
                .map(id => columns.find(c => c.id === id))
                .filter(Boolean)
                .forEach(col => {
                    const opt = document.createElement('option');
                    opt.value = col.id;
                    opt.textContent = col.title;
                    columnSelect.appendChild(opt);
                });

            if (previousValue && allowedIds.includes(parseInt(previousValue))) {
                columnSelect.value = previousValue;
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
        }

        // Formate une date pour l'affichage (jj mmm. yyyy)
        function formatDateDisplay(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const day = date.getDate();
            const months = ['jan.', 'f√©v.', 'mar.', 'avr.', 'mai', 'juin', 
                           'juil.', 'ao√ª.', 'sep.', 'oct.', 'nov.', 'd√©c.'];
            const month = months[date.getMonth()];
            const year = date.getFullYear();
            return `${day} ${month} ${year}`;
        }

        // Obtient l'ic√¥ne de priorit√©
        function getPriorityIcon(priority) {
            const icons = { 'low': 'üü¢', 'medium': 'üü°', 'high': 'üî¥' };
            return icons[priority] || '‚ö™';
        }

        function getPriorityLabel(priority) {
            const labels = { low: 'Basse', medium: 'Moyenne', high: 'Haute' };
            return labels[priority] || priority;
        }

        function saveToLocalStorage() {
            localStorage.setItem('kanbanColumns', JSON.stringify(columns));
            localStorage.setItem('kanbanCards', JSON.stringify(cards));
            localStorage.setItem('kanban_sections', JSON.stringify(sections));
        }

        // Export PDF
        async function exportToPDF() {
            const { jsPDF } = window.jspdf;
            
            const calendarView = document.getElementById('calendarView');
            const kanbanContainer = document.getElementById('kanbanContainer');
            const isCalendarView = calendarView.classList.contains('show');
            
            const elementToCapture = isCalendarView ? calendarView : kanbanContainer;
            
            try {
                const canvas = await html2canvas(elementToCapture, {
                    backgroundColor: '#1a1a1a',
                    scale: 2,
                    logging: false,
                    useCORS: true
                });

                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF({
                    orientation: canvas.width > canvas.height ? 'landscape' : 'portrait',
                    unit: 'px',
                    format: [canvas.width, canvas.height]
                });

                pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                
                const filename = isCalendarView ?
                    `kanban-calendrier-${Date.now()}.pdf` :
                    `kanban-${currentView}-${Date.now()}.pdf`;
                
                pdf.save(filename);
                alert('Export PDF r√©ussi !');
            } catch (error) {
                console.error('Erreur lors de l\'export PDF:', error);
                alert('Erreur lors de l\'export PDF. Veuillez r√©essayer.');
            }
        }

        // Exporte les donn√©es au format JSON
        function exportData() {
            // Collecter tous les ordres de colonnes par section
            const columnOrders = {};
            sections.forEach(section => {
                const order = getSectionOrder(section.id);
                if (order && order.length > 0) {
                    columnOrders[section.id] = order;
                }
            });

            const data = {
            appTitle: localStorage.getItem('appTitle') || '‚úÖ KanBan DGCE',
                columns: columns,
                cards: cards,
                sections: sections,
                columnOrders: columnOrders,
                exportDate: new Date().toISOString(),
                version: '3.0'
            };

            const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const link = document.createElement('a');
            link.href = url;
            link.download = `kanban-dgce-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            alert('Export JSON r√©ussi !');
        }

        // Import
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);

                        if (!data.columns || !data.cards || !data.sections) {
                            alert('Format de fichier invalide. Le fichier doit contenir "columns", "cards" et "sections".');
                            return;
                        }
                        if (!Array.isArray(data.columns) || !Array.isArray(data.cards) || !Array.isArray(data.sections)) {
                            alert('Format de fichier invalide. "columns", "cards" et "sections" doivent √™tre des tableaux.');
                            return;
                        }

                        console.log('Import - Sections avant:', sections.length, sections.map(s => s.name));
                        console.log('Import - Colonnes avant:', columns.length);
                        console.log('Import - Cartes avant:', cards.length);

                        if (data.appTitle) {
                            localStorage.setItem('appTitle', data.appTitle);
                            loadAppTitle();
                        }

                        data.columns.forEach(col => {
                            const existing = columns.find(c => c.id === col.id);
                            if (!existing) {
                                columns.push(col);
                                console.log('Ajout colonne:', col.title);
                            } else {
                                existing.title = col.title;
                                existing.color = col.color;
                                if (col.order !== undefined) existing.order = col.order;
                                console.log('Mise √† jour colonne:', col.title);
                            }
                        });

                        const allColumnIds = (Array.isArray(columns) && columns.length) ? columns.map(c => c.id) : [];

                        const getNextSectionId = () => {
                            const maxId = sections.length ? Math.max(...sections.map(s => s.id || 0)) : 0;
                            return maxId + 1;
                        };

                        const normalizeCols = (arr) => {
                            if (!Array.isArray(arr)) return [];
                            return arr.map(x => parseInt(x)).filter(id => allColumnIds.includes(id));
                        };

                        const ensureSectionByName = (name) => {
                            if (!name) return null;
                            let sec = sections.find(s => s.name === name);
                            if (sec) {
                                if (!Array.isArray(sec.columns)) sec.columns = [];
                                return sec;
                            }
                            const newId = getNextSectionId();
                            sec = { id: newId, name: name, color: null, columns: [] };
                            sections.push(sec);
                            console.log('Ajout section (depuis carte):', name);
                            return sec;
                        };

                        data.sections.forEach(sec => {
                            if (!sec || !sec.name) return;

                            const existingByName = sections.find(s => s.name === sec.name);
                            const importedCols = normalizeCols(sec.columns);

                            if (existingByName) {
                                if (sec.color) existingByName.color = sec.color;
                                if (!Array.isArray(existingByName.columns)) existingByName.columns = [];
                                if (importedCols.length) {
                                    const localCols = normalizeCols(existingByName.columns);
                                    existingByName.columns = Array.from(new Set(localCols.concat(importedCols)));
                                }
                                console.log('Mise √† jour section (par nom):', sec.name, 'Colonnes:', existingByName.columns);
                            } else {
                                const newId = sections.some(s => s.id === sec.id) ? getNextSectionId() : (sec.id || getNextSectionId());
                                sections.push({ id: newId, name: sec.name, color: sec.color || null, columns: importedCols });
                                console.log('Ajout section:', sec.name, 'Colonnes:', importedCols);
                            }
                        });

                        data.cards.forEach(card => {
                            if (!card) return;
                            if (!card.lastUpdated) card.lastUpdated = new Date().getTime();

                            const existing = cards.find(c => c.id === card.id);
                            if (!existing) {
                                cards.push(card);
                                console.log('Ajout carte:', card.title);
                            } else {
                                const existingTime = existing.lastUpdated || 0;
                                if (card.lastUpdated > existingTime) {
                                    Object.assign(existing, card);
                                    console.log('Mise √† jour carte:', card.title);
                                }
                            }

                            if (card.section && card.columnId) {
                                const sec = ensureSectionByName(card.section);
                                const colId = parseInt(card.columnId);
                                if (sec && allColumnIds.includes(colId)) {
                                    if (!sec.columns.includes(colId)) {
                                        sec.columns.push(colId);
                                    }
                                }
                            }
                        });

                        sections.forEach(sec => {
                            if (!Array.isArray(sec.columns)) sec.columns = [];
                            sec.columns = sec.columns.map(x => parseInt(x)).filter(id => allColumnIds.includes(id));
                        });

                        console.log('Import - Sections apr√®s:', sections.length, sections.map(s => ({name: s.name, cols: s.columns})));
                        console.log('Import - Colonnes apr√®s:', columns.length);
                        console.log('Import - Cartes apr√®s:', cards.length);

                        
                        // Restaurer les ordres de colonnes par section si disponibles
                        if (data.columnOrders) {
                            Object.keys(data.columnOrders).forEach(sectionId => {
                                const order = data.columnOrders[sectionId];
                                if (Array.isArray(order) && order.length > 0) {
                                    saveSectionOrder(sectionId, order);
                                }
                            });
                            console.log('Import - Ordres de colonnes restaur√©s');
                        }

                        saveToLocalStorage();
                        renderSectionsList();
                        updateSectionButtons();
                        updateSectionSelect();
                        updateAllViews();

                        alert('‚úÖ Donn√©es import√©es et fusionn√©es avec succ√®s !');
                    } catch (error) {
                        console.error('Erreur lors de l\'importation:', error);
                        alert('‚ùå Erreur lors de l\'importation: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // Efface toutes les donn√©es
        function clearAllData() {
            if (!confirm('‚ö†Ô∏è ATTENTION !\n\nCette action va :\n‚Ä¢ Effacer TOUTES les t√¢ches\n‚Ä¢ Effacer TOUTES les colonnes\n‚Ä¢ Effacer TOUTES les sections\n\nVotre titre personnalis√© sera conserv√©.\n\nContinuer ?')) {
                return;
            }

            // Double confirmation
            if (!confirm('Derni√®re confirmation : √™tes-vous absolument certain de vouloir effacer toutes les donn√©es ?\n\nCette action est irr√©versible !')) {
                return;
            }

            // Effacer toutes les colonnes
            columns = [];

            // Effacer toutes les cartes
            cards = [];

            // Effacer toutes les sections
            sections = [];

            // Nettoyer TOUS les ordres de colonnes dans localStorage
            Object.keys(localStorage).forEach(key => {
                if (key.startsWith('order:section:')) {
                    localStorage.removeItem(key);
                }
            });

            // Sauvegarder
            saveSections();
            saveToLocalStorage();
            updateSectionButtons();
            updateSectionSelect();
            currentView = 'general';
            updateAllViews();

            alert('‚úÖ Nettoyage effectu√© !\n\n‚Ä¢ Toutes les t√¢ches supprim√©es\n‚Ä¢ Toutes les colonnes supprim√©es\n‚Ä¢ Toutes les sections supprim√©es\n‚Ä¢ Titre conserv√©\n\nVue G√©n√©ral est maintenant vide.');
        }

        
        // R√©initialise TOTALEMENT l'application
        function resetApplication() {
            if (!confirm('‚ö†Ô∏è R√âINITIALISATION TOTALE ‚ö†Ô∏è\n\nCette action va TOUT effacer et r√©initialiser l\'application aux param√®tres d\'usine :\n\n‚Ä¢ Toutes les t√¢ches\n‚Ä¢ Toutes les colonnes\n‚Ä¢ Toutes les sections\n‚Ä¢ Le titre\n\nCette action est IRR√âVERSIBLE !\n\nContinuer ?')) {
                return;
            }

            // Double confirmation
            if (!confirm('üî¥ DERNI√àRE CONFIRMATION üî¥\n\n√ätes-vous ABSOLUMENT CERTAIN de vouloir r√©initialiser TOTALEMENT l\'application ?\n\nToutes vos donn√©es seront D√âFINITIVEMENT perdues !')) {
                return;
            }

            // R√©initialiser les colonnes par d√©faut
            columns = [
                { id: 1, title: '√Ä faire', color: 'rgba(100,149,237,0.3)', order: 0 },
                { id: 2, title: 'En cours', color: 'rgba(0,122,255,0.3)', order: 1 },
                { id: 3, title: 'En r√©vision', color: 'rgba(255,149,0,0.3)', order: 2 },
                { id: 4, title: 'Termin√©', color: 'rgba(52,199,89,0.3)', order: 3 }
            ];

            // Effacer toutes les cartes
            cards = [];

            // R√©initialiser les sections par d√©faut
            sections = [
                { id: 1, name: 'SOA', color: '#0066cc', columns: [1, 2, 3, 4] },
                { id: 2, name: 'SMSC', color: '#4ecca3', columns: [1, 2, 3, 4] },
                { id: 3, name: 'SOSC', color: '#ffa500', columns: [1, 2, 3, 4] },
                { id: 4, name: 'SBO', color: '#ff6b9d', columns: [1, 2, 3, 4] },
                { id: 5, name: 'Transverse', color: '#9b59b6', columns: [1, 2, 3, 4] }
            ];

            // R√©initialiser le titre
            localStorage.setItem('appTitle', '‚úÖ KanBan DGCE');
            loadAppTitle();

            // Nettoyer TOUT le localStorage des ordres
            Object.keys(localStorage).forEach(key => {
                if (key.startsWith('order:section:')) {
                    localStorage.removeItem(key);
                }
            });

            // Sauvegarder tout
            saveSections();
            saveToLocalStorage();
            updateSectionButtons();
            updateSectionSelect();
            currentView = 'general';
            updateAllViews();

            alert('‚úÖ Application r√©initialis√©e avec succ√®s !\n\nL\'application a √©t√© restaur√©e aux param√®tres d\'usine.');
        }

        
        function initSections() {
            const saved = localStorage.getItem('kanban_sections');
            if (saved) {
                sections = JSON.parse(saved);
                sections = sections.map(s => {
                    if (!s.columns) {
                        s.columns = [1, 2, 3, 4];
                    }
                    return s;
                });
                saveSections();
            } else {
                sections = [
                    { id: 1, name: 'SOA', color: '#0066cc', columns: [1, 2, 3, 4] },
                    { id: 2, name: 'SMSC', color: '#4ecca3', columns: [1, 2, 3, 4] },
                    { id: 3, name: 'SOSC', color: '#ffa500', columns: [1, 2, 3, 4] },
                    { id: 4, name: 'SBO', color: '#ff6b9d', columns: [1, 2, 3, 4] },
                    { id: 5, name: 'Transverse', color: '#9b59b6', columns: [1, 2, 3, 4] }
                ];
                saveSections();
            }
        }

        function saveSections() {
            localStorage.setItem('kanban_sections', JSON.stringify(sections));
        }

        function updateSectionButtons() {
            const viewSelector = document.querySelector('.view-selector');
            if (!viewSelector) return;

            viewSelector.innerHTML = '<button class="view-btn active" onclick="switchView(\'general\')">G√©n√©ral</button>';

            sections.forEach(section => {
                const btn = document.createElement('button');
                btn.className = 'view-btn';
                btn.textContent = section.name;
                btn.setAttribute('data-section-color', section.color);
                btn.onclick = () => switchView(section.name.toLowerCase());
                viewSelector.appendChild(btn);
            });
        }

        function updateSectionSelect() {
            const select = document.getElementById('cardSection');
            if (!select) return;

            const currentValue = select.value;
            select.innerHTML = '';

            // Ajouter une option vide
            const emptyOption = document.createElement('option');
            emptyOption.value = '';
            emptyOption.textContent = '';
            select.appendChild(emptyOption);

            sections.forEach(section => {
                const option = document.createElement('option');
                option.value = section.name;
                option.textContent = section.name;
                select.appendChild(option);
            });

            if (currentValue && sections.find(s => s.name === currentValue)) {
                select.value = currentValue;
            }
        
            select.onchange = () => {
                updateColumnSelects();
            };
        }

        function openSectionsManagementModal() {
            // FERMER Param√®tres en utilisant classList
            const settingsModal = document.getElementById('settingsModal');
            if (settingsModal) {
                settingsModal.classList.remove('show');
            }

            // OUVRIR Sections
            const sectionsModal = document.getElementById('sectionsManagementModal');
            if (sectionsModal) {
                sectionsModal.style.display = 'flex';
                sectionsModal.style.position = 'fixed';
                sectionsModal.style.top = '0';
                sectionsModal.style.left = '0';
                sectionsModal.style.width = '100%';
                sectionsModal.style.height = '100%';
                sectionsModal.style.zIndex = '9999';
                sectionsModal.style.background = 'rgba(0,0,0,0.7)';
                sectionsModal.style.justifyContent = 'center';
                sectionsModal.style.alignItems = 'center';
                renderSectionsList();
            }
        }

        function closeSectionsManagementModal() {
            const modal = document.getElementById('sectionsManagementModal');
            if (modal) {
                modal.style.display = 'none';
                modal.style.zIndex = '';
                modal.style.position = '';
                modal.style.top = '';
                modal.style.left = '';
                modal.style.width = '';
                modal.style.height = '';
                modal.style.background = '';
                modal.style.justifyContent = '';
                modal.style.alignItems = '';
            }

            updateSectionButtons();
            updateSectionSelect();

            // Rouvrir la modale de param√®tres en utilisant classList.add('show')
            const settingsModal = document.getElementById('settingsModal');
            if (settingsModal) {
                settingsModal.classList.add('show');
            }
        }

        function renderSectionsList() {
            const container = document.getElementById('sectionsList');
            if (!container) return;

            container.innerHTML = '';
            sections.forEach(section => {
                const div = document.createElement('div');
                div.innerHTML = `
                    <div style="display:flex; align-items:center; gap:10px;">
                        <div style="width:20px; height:20px; background:${section.color}; border-radius:4px; cursor:pointer;" title="Cliquer pour changer la couleur" onclick="openColorPicker(${section.id})"></div>
                        <span style="font-weight:500; color:white;">${section.name}</span>
                    </div>
                    <div style="display:flex; gap:8px;">
                        <button onclick="openSectionModal(${section.id})" style="padding:8px 12px; background:#6495ed; color:white; border:none; border-radius:6px; cursor:pointer;">Modifier</button>
                        <button onclick="deleteSection(${section.id})" style="padding:8px 12px; background:#ff4444; color:white; border:none; border-radius:6px; cursor:pointer;">Supprimer</button>
                    </div>
                `;
                div.style.cssText = 'display:flex; justify-content:space-between; align-items:center; padding:15px; margin-bottom:10px; background:rgba(255,255,255,0.08); border-radius:12px; border-left:4px solid ' + section.color;
                container.appendChild(div);
            });
        }

        function openColorPicker(sectionId) {
            const modal = document.getElementById('colorPickerModal');
            if (!modal) {
                // Cr√©er la modale si elle n'existe pas
                const modalDiv = document.createElement('div');
                modalDiv.id = 'colorPickerModal';
                modalDiv.className = 'modal';
                modalDiv.style.zIndex = '10000';
                modalDiv.innerHTML = `
                    <div class="modal-content" style="max-width: 500px;">
                        <h2 style="color:white; margin-bottom:20px;">Choisir une couleur</h2>
                        <div id="colorPickerGrid" style="display:grid; grid-template-columns:repeat(6, 60px); gap:10px; justify-content:center; margin-bottom:20px;">
                        </div>
                        <button onclick="closeModal('colorPickerModal')" style="padding:12px 24px; background:#666; color:white; border:none; border-radius:8px; cursor:pointer; width:100%;">Annuler</button>
                    </div>
                `;
                document.body.appendChild(modalDiv);
            }

            // Remplir la grille de couleurs
            const grid = document.getElementById('colorPickerGrid');
            const section = sections.find(s => s.id === sectionId);
            const currentColor = section ? section.color : '';

            grid.innerHTML = colorPalette.map(color => `
                <div style="width:60px; height:60px; background:${color}; border-radius:8px; cursor:pointer; border:3px solid ${color === currentColor ? 'white' : 'transparent'}; transition: all 0.2s;" 
                     onclick="selectSectionColor(${sectionId}, '${color}')"
                     onmouseover="this.style.transform='scale(1.1)'"
                     onmouseout="this.style.transform='scale(1)'">
                </div>
            `).join('');

            document.getElementById('colorPickerModal').classList.add('show');
        }

        function selectSectionColor(sectionId, color) {
            const section = sections.find(s => s.id === sectionId);
            if (section) {
                section.color = color;
                saveSections();
                closeModal('colorPickerModal');
                setTimeout(() => {
                    renderSectionsList();
                    updateSectionButtons();
                    renderKanban();
                }, 100);
            }
        }

        function openSectionModal(editId = null) {
            const title = document.getElementById('sectionModalTitle');
            const input = document.getElementById('sectionName');
            const hiddenId = document.getElementById('editingSectionId');

            if (editId) {
                const section = sections.find(s => s.id === editId);
                if (section) {
                    title.textContent = 'Modifier Section';
                    input.value = section.name;
                    hiddenId.value = editId;
                }
            } else {
                title.textContent = 'Ajouter Section';
                input.value = '';
                hiddenId.value = '';
            }

            const modal = document.getElementById('sectionModal');
            if (modal) {
                openModal('sectionModal');
                modal.style.position = 'fixed';
                modal.style.top = '0';
                modal.style.left = '0';
                modal.style.width = '100%';
                modal.style.height = '100%';
                modal.style.zIndex = '10000';
                modal.style.background = 'rgba(0,0,0,0.7)';
                modal.style.justifyContent = 'center';
                modal.style.alignItems = 'center';
            }
        }

        function closeSectionModal() {
            const modal = document.getElementById('sectionModal');
            if (modal) modal.style.display = 'none';
        }

        function saveSection() {
            const input = document.getElementById('sectionName');
            const hiddenId = document.getElementById('editingSectionId');
            const name = input.value.trim();

            if (!name) {
                alert('Nom requis');
                return;
            }

            const id = hiddenId.value ? parseInt(hiddenId.value) : null;

            if (id) {
                const section = sections.find(s => s.id === id);
                if (section) {
                    const oldName = section.name;
                    section.name = name;

                    if (typeof cards !== 'undefined' && oldName !== name) {
                        cards.forEach(card => {
                            if (card.section === oldName) {
                                card.section = name;
                            }
                        });
                        saveToLocalStorage();
                    }
                }
            } else {
                const newId = sections.length ? Math.max(...sections.map(s => s.id)) + 1 : 1;

                // Attribution intelligente : prendre la premi√®re couleur non utilis√©e
                const usedColors = sections.map(s => s.color);
                let selectedColor = colorPalette.find(color => !usedColors.includes(color));

                // Si toutes les couleurs sont utilis√©es, prendre une au hasard
                if (!selectedColor) {
                    selectedColor = colorPalette[Math.floor(Math.random() * colorPalette.length)];
                }

                sections.push({ id: newId, name: name, color: selectedColor, columns: [] });
            }

            saveSections();
            renderSectionsList();
            updateSectionButtons();
            updateSectionSelect();
            renderKanban();
            closeSectionModal();
        }

        function deleteSection(id) {
            if (!confirm('Supprimer cette section ?')) return;

            const section = sections.find(s => s.id === id);
            if (!section) return;

            const sectionName = section.name;
            const sectionColumns = section.columns || [];

            const columnsToDelete = sectionColumns.filter(colId => {
                const usedElsewhere = sections.some(s => s.id !== id && s.columns && s.columns.includes(colId));
                const hasCards = cards.some(c => c.columnId === colId);
                return !usedElsewhere && !hasCards;
            });

            columns = columns.filter(col => !columnsToDelete.includes(col.id));
            sections = sections.filter(s => s.id !== id);
            saveSections();

            if (typeof cards !== 'undefined') {
                cards.forEach(card => {
                    if (card.section === sectionName) {
                        card.section = '';
                    }
                });
                saveToLocalStorage();
            }

            renderSectionsList();
            updateSectionButtons();
            updateSectionSelect();
            renderKanban();
        }

        initSections();
            updateSectionButtons();
            updateSectionSelect();

        function loadAppTitle() {
            const saved = localStorage.getItem('appTitle');
            const title = saved || '‚úÖ KanBan DGCE';
            const h1 = document.querySelector('.header h1');
            if (h1) h1.textContent = title;
            document.title = title;
        }

        function openTitleModal() {
            const modal = document.getElementById('titleModal');
            const input = document.getElementById('appTitleInput');
            input.value = localStorage.getItem('appTitle') || '‚úÖ KanBan DGCE';
            modal.classList.add('show');
            input.focus();
        }

        function saveAppTitle() {
            const input = document.getElementById('appTitleInput');
            const title = input.value.trim();
            if (!title) { alert('Le titre ne peut pas √™tre vide'); return; }
            localStorage.setItem('appTitle', title);
            loadAppTitle();
            closeModal('titleModal');
            saveToLocalStorage();
        }


    /* --- LOGIQUE CALENDRIER --- */
    let currentCalendarDate = new Date();

    function renderCalendar() {
        const grid = document.getElementById('calendarGrid');
        if (!grid) return;
        grid.innerHTML = '';

        const today = new Date();
        const displayDate = currentCalendarDate;

        // Mise √† jour titre mois
        const monthDisplay = document.getElementById('calendarMonthDisplay');
        if (monthDisplay) {
            monthDisplay.textContent = displayDate.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
        }

        const year = displayDate.getFullYear();
        const month = displayDate.getMonth();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        for (let day = 1; day <= daysInMonth; day++) {
            const dateObj = new Date(year, month, day);

            // D√©tection jour actuel
            const isToday = dateObj.getDate() === today.getDate() && 
                           dateObj.getMonth() === today.getMonth() && 
                           dateObj.getFullYear() === today.getFullYear();

            // Filtrage cartes
            let dayCards = cards.filter(card => {
                if (!card.dueDate) return false;
                const cardDate = new Date(card.dueDate);
                return cardDate.getDate() === day &&
                       cardDate.getMonth() === month &&
                       cardDate.getFullYear() === year;
            });

            if (currentView !== 'general') {
                dayCards = dayCards.filter(card => card.section.toLowerCase() === currentView.toLowerCase());
            }

            const dayDiv = document.createElement('div');
            // Application classe halo si aujourd'hui
            dayDiv.className = isToday ? 'calendar-day today-highlight' : 'calendar-day';

            dayDiv.innerHTML = `
                <div class="calendar-day-header">${day} ${dateObj.toLocaleDateString('fr-FR', { weekday: 'short' })}</div>
                
                ${dayCards.map(card => {
                    const section = sections.find(s => s.name.toLowerCase() === card.section.toLowerCase());
                    const bgColor = section ? section.color : 'rgba(100,149,237,0.3)';
                    const sectionText = card.section && card.section.trim() ? ` - ${card.section}` : '';
                    return `<div class="calendar-task" style="background:${bgColor}; border-left-color:${bgColor}; color:#f5f5f7;" onclick="showTaskDetail(${card.id}, event)">${card.title}${sectionText}</div>`;
                }).join('')}

            `;
            grid.appendChild(dayDiv);
        }
    }

    function previousMonth() { currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1); renderCalendar(); }
    function nextMonth() { currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1); renderCalendar(); }
    function goToToday() { currentCalendarDate = new Date(); renderCalendar(); }

        // ===== MODAL HELPERS (V61) =====
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            // Directly set style here to avoid recursion loop from regex replacement
            modal.style.display = 'flex';
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            modal.style.display = 'none';
            modal.classList.remove('show');
            document.body.style.overflow = 'auto';
        }

        function setupModalOverlayClose() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.style.display = 'none';
                        modal.classList.remove('show');
                        document.body.style.overflow = 'auto';
                    }
                });
            });
        }

        document.addEventListener('DOMContentLoaded', setupModalOverlayClose);

        function updateAllViews() {
            renderKanban();
            renderCalendar();
        }




// ============================================
// COMPTES RENDUS DE R√âUNION - V80
// ============================================

let meetingReports = JSON.parse(localStorage.getItem('meetingReports')) || [];
let resources = JSON.parse(localStorage.getItem('resources')) || [];
let meetingTags = JSON.parse(localStorage.getItem('meetingTags')) || [];
let mainUser = JSON.parse(localStorage.getItem('mainUser')) || {
    name: '', 
    grade: '',
    unit: '',
    email: '',
    isMain: true
};
let currentEditingMR = null;

function saveMeetingReportsToStorage() {
    localStorage.setItem('meetingReports', JSON.stringify(meetingReports));
}

function saveResourcesToStorage() {
    localStorage.setItem('resources', JSON.stringify(resources));
}

function saveMeetingTagsToStorage() {
    localStorage.setItem('meetingTags', JSON.stringify(meetingTags));
}

function saveMainUserToStorage() {
    localStorage.setItem('mainUser', JSON.stringify(mainUser));
}

// Wrapper pour switchView pour g√©rer la vue R√©unions
(function() {
    const originalSwitchView = typeof switchView !== 'undefined' ? switchView : function() {};
    window.switchView = function(view) {
        if (view === 'reunions') {
            currentView = 'reunions';
            document.getElementById('kanbanContainer').style.display = 'none';
            const calView = document.getElementById('calendarView');
            if (calView) calView.classList.remove('show');

            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.style.boxShadow = '';
                btn.style.borderColor = '';
            });

            if (typeof event !== 'undefined' && event.target) {
                event.target.classList.add('active');
                const color = '#8e44ad';
                const r = 142, g = 68, b = 173;
                event.target.style.borderColor = color;
                event.target.style.boxShadow = `0 4px 15px rgba(${r},${g},${b},0.4)`;
            }

            openMeetingReportsListModal();
            localStorage.setItem('currentView', 'reunions');
        } else {
            originalSwitchView(view);
        }
    };
})();

// Ouvrir la liste des CR
function openMeetingReportsListModal() {
    renderMeetingReportsList();
    openModal('meetingReportsListModal');
}

// Render liste des CR
function renderMeetingReportsList() {
    const container = document.getElementById('meetingReportsList');
    if (!container) return;

    if (meetingReports.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #888;">Aucun compte rendu. Cr√©ez-en un avec le bouton ci-dessus.</div>';
        return;
    }

    const sorted = [...meetingReports].sort((a, b) => new Date(b.statusDate) - new Date(a.statusDate));

    container.innerHTML = sorted.map(mr => {
        const statusClass = `mr-status-${mr.status}`;
        const statusIcon = mr.status === 'brouillon' ? '‚ö™' : mr.status === 'encours' ? 'üü†' : 'üü¢';
        const statusLabel = mr.status === 'brouillon' ? 'Brouillon' : mr.status === 'encours' ? 'En cours' : 'Valid√©';
        const borderColor = mr.status === 'brouillon' ? '#9e9e9e' : mr.status === 'encours' ? '#ff9800' : '#4caf50';

        const tagsHtml = mr.tags && mr.tags.length > 0 ? 
            `<div class="mr-tags">${mr.tags.map(tag => `<span class="mr-tag">${tag}</span>`).join('')}</div>` : '';

        const sectionsText = mr.sections && mr.sections.length > 0 ? mr.sections.join(', ') : 'G√©n√©ral';

        return `
            <div class="mr-card" style="border-left-color: ${borderColor};">
                <div class="mr-card-header">
                    <div class="mr-card-title">üìã ${mr.title}</div>
                    <span class="mr-status-badge ${statusClass}">${statusIcon} ${statusLabel}</span>
                </div>
                <div class="mr-meta">
                    <span>üìÖ ${formatDateDisplay(mr.statusDate)}</span>
                    <span>üë• ${mr.participants ? mr.participants.length : 0} participants</span>
                    <span>üìÇ ${sectionsText}</span>
                </div>
                ${tagsHtml}
                <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: flex-end;">
                    <button class="btn btn-secondary btn-small" onclick="event.stopPropagation(); editMeetingReport(${mr.id})">‚úèÔ∏è Modifier</button>
                    <button class="btn btn-secondary btn-small" onclick="event.stopPropagation(); deleteMeetingReport(${mr.id})">üóëÔ∏è Supprimer</button>
                </div>
            </div>
        `;
    }).join('');
}

// Ouvrir le formulaire CR
function openMeetingReportModal(mrId = null) {
    currentEditingMR = mrId;
    const title = document.getElementById('meetingReportModalTitle');

    if (mrId) {
        title.textContent = 'üìã Modifier le Compte Rendu';
        loadMeetingReportData(mrId);
    } else {
        title.textContent = 'üìã Nouveau Compte Rendu';
        resetMeetingReportForm();
    }

    renderMRSectionsCheckboxes();
    renderMRParticipants();
    renderMRTags();
    openModal('meetingReportModal');
}

// Reset formulaire
function resetMeetingReportForm() {
    document.getElementById('mrTitle').value = '';
    document.getElementById('mrStatus').value = 'brouillon';
    document.getElementById('mrStatusDate').value = new Date().toISOString().split('T')[0];

    window.currentMRTags = [];
    window.currentMRSections = ['G√©n√©ral'];
    window.currentMRParticipants = [{
        name: mainUser.name, 
        unit: mainUser.unit, 
        isOrganizer: true
    }];

    renderMRTags();
    resetTable('agendaPast');
    resetTable('agendaCurrent');
    resetTable('agendaNext');
    resetTable('discussionsTable');
}

// Charger les donn√©es d'un CR
function loadMeetingReportData(mrId) {
    const mr = meetingReports.find(m => m.id === mrId);
    if (!mr) return;

    document.getElementById('mrTitle').value = mr.title || '';
    document.getElementById('mrStatus').value = mr.status || 'brouillon';
    document.getElementById('mrStatusDate').value = mr.statusDate || '';

    window.currentMRTags = mr.tags || [];
    window.currentMRSections = mr.sections || ['G√©n√©ral'];
    window.currentMRParticipants = mr.participants || [{name: mainUser.name, unit: mainUser.unit, isOrganizer: true}];

    renderMRTags();
    renderMRParticipants();
    loadTableData('agendaPast', mr.agendaPast);
    loadTableData('agendaCurrent', mr.agendaCurrent);
    loadTableData('agendaNext', mr.agendaNext);
    loadTableData('discussionsTable', mr.discussions);
}

// Sauvegarder le CR
function saveMeetingReport() {
    const title = document.getElementById('mrTitle').value.trim();
    if (!title) {
        alert('Veuillez saisir un titre');
        return;
    }

    const mr = {
        id: currentEditingMR || Date.now(),
        title: title,
        status: document.getElementById('mrStatus').value,
        statusDate: document.getElementById('mrStatusDate').value,
        tags: window.currentMRTags || [],
        sections: window.currentMRSections || ['G√©n√©ral'],
        participants: window.currentMRParticipants || [],
        agendaPast: getTableData('agendaPast'),
        agendaCurrent: getTableData('agendaCurrent'),
        agendaNext: getTableData('agendaNext'),
        discussions: getTableData('discussionsTable'),
        lastUpdated: new Date().getTime()
    };

    if (currentEditingMR) {
        const index = meetingReports.findIndex(m => m.id === currentEditingMR);
        if (index >= 0) meetingReports[index] = mr;
    } else {
        meetingReports.push(mr);
    }

    saveMeetingReportsToStorage();
    closeModal('meetingReportModal');
    renderMeetingReportsList();

    if (typeof renderCalendar === 'function') {
        renderCalendar();
    }
}

function editMeetingReport(mrId) {
    openMeetingReportModal(mrId);
}

function deleteMeetingReport(mrId) {
    if (!confirm('Supprimer ce compte rendu ?')) return;

    meetingReports = meetingReports.filter(mr => mr.id !== mrId);
    saveMeetingReportsToStorage();
    renderMeetingReportsList();

    if (typeof renderCalendar === 'function') {
        renderCalendar();
    }
}

// GESTION TAGS
if (!window.currentMRTags) window.currentMRTags = [];

function renderMRTags() {
    const container = document.getElementById('mrTagsContainer');
    if (!container) return;

    const tags = window.currentMRTags || [];
    container.innerHTML = tags.map(tag => {
        const escaped = tag.replace(/'/g, "\'").replace(/"/g, '&quot;');
        return `<span class="tag-chip">${tag}<button onclick="removeMRTag('${escaped}')">√ó</button></span>`;
    }).join('');
}

function handleMRTagInput(event) {
    if (event.key === 'Enter') {
        event.preventDefault();
        const input = document.getElementById('mrTagInput');
        const value = input.value.trim();
        if (value && !window.currentMRTags.includes(value)) {
            window.currentMRTags.push(value);
            renderMRTags();
        }
        input.value = '';
        document.getElementById('mrTagSuggestions').style.display = 'none';
    }
}

function showMRTagSuggestions(event) {
    const input = event.target;
    const value = input.value.toLowerCase().trim();
    const container = document.getElementById('mrTagSuggestions');

    if (!value) {
        container.style.display = 'none';
        return;
    }

    const suggestions = meetingTags.filter(tag => 
        tag.toLowerCase().includes(value) && !window.currentMRTags.includes(tag)
    );

    if (suggestions.length === 0) {
        container.style.display = 'none';
        return;
    }

    container.innerHTML = suggestions.map(tag => {
        const escaped = tag.replace(/'/g, "\'").replace(/"/g, '&quot;');
        return `<div class="suggestion-item" onclick="selectMRTag('${escaped}')">${tag}</div>`;
    }).join('');
    container.style.display = 'block';
}

function selectMRTag(tag) {
    if (!window.currentMRTags.includes(tag)) {
        window.currentMRTags.push(tag);
        renderMRTags();
    }
    document.getElementById('mrTagInput').value = '';
    document.getElementById('mrTagSuggestions').style.display = 'none';
}

function removeMRTag(tag) {
    window.currentMRTags = window.currentMRTags.filter(t => t !== tag);
    renderMRTags();
}

// GESTION SECTIONS
if (!window.currentMRSections) window.currentMRSections = ['G√©n√©ral'];

function renderMRSectionsCheckboxes() {
    const container = document.getElementById('mrSectionsContainer');
    if (!container) return;

    const allSections = ['G√©n√©ral', ...sections.map(s => s.name)];

    container.innerHTML = allSections.map(sectionName => {
        const isChecked = window.currentMRSections && window.currentMRSections.includes(sectionName);
        const escaped = sectionName.replace(/'/g, "\'").replace(/"/g, '&quot;');
        return `
            <label class="section-checkbox ${isChecked ? 'selected' : ''}">
                <input type="checkbox" 
                       ${isChecked ? 'checked' : ''} 
                       onchange="toggleMRSection('${escaped}', this.checked)">
                ${sectionName}
            </label>
        `;
    }).join('');
}

function toggleMRSection(sectionName, checked) {
    if (!window.currentMRSections) window.currentMRSections = [];

    if (checked) {
        if (!window.currentMRSections.includes(sectionName)) {
            window.currentMRSections.push(sectionName);
        }
    } else {
        window.currentMRSections = window.currentMRSections.filter(s => s !== sectionName);
    }

    renderMRSectionsCheckboxes();
}

// GESTION PARTICIPANTS
if (!window.currentMRParticipants) {
    window.currentMRParticipants = [{name: mainUser.name, unit: mainUser.unit, isOrganizer: true}];
}

function renderMRParticipants() {
    const container = document.getElementById('mrParticipantsContainer');
    if (!container) return;

    const participants = window.currentMRParticipants || [];
    container.innerHTML = participants.map((p, index) => {
        const chipClass = p.isOrganizer ? 'chip-organizer' : 'chip-attendee';
        const icon = p.isOrganizer ? 'üë§ ' : '';
        const removeBtn = p.isOrganizer ? '' : `<button class="chip-remove" onclick="removeMRParticipant(${index})">√ó</button>`;

        return `
            <span class="participant-chip ${chipClass}">
                ${icon}${p.name}${p.unit ? ' (' + p.unit + ')' : ''}
                ${removeBtn}
            </span>
        `;
    }).join('');
}

function handleParticipantInput(event) {
    if (event.key === 'Enter') {
        event.preventDefault();
        const input = document.getElementById('mrParticipantInput');
        const value = input.value.trim();
        if (value) {
            addMRParticipant(value);
            input.value = '';
            document.getElementById('mrParticipantSuggestions').style.display = 'none';
        }
    }
}

function showParticipantSuggestions(event) {
    const input = event.target;
    const value = input.value.toLowerCase().trim();
    const container = document.getElementById('mrParticipantSuggestions');

    if (!value) {
        container.style.display = 'none';
        return;
    }

    const currentNames = (window.currentMRParticipants || []).map(p => p.name);
    const suggestions = resources.filter(r => 
        r.name.toLowerCase().includes(value) && !currentNames.includes(r.name)
    );

    if (suggestions.length === 0) {
        container.style.display = 'none';
        return;
    }

    container.innerHTML = suggestions.map(r => {
        const nameEsc = r.name.replace(/'/g, "\'").replace(/"/g, '&quot;');
        const unitEsc = (r.unit || '').replace(/'/g, "\'").replace(/"/g, '&quot;');
        return `<div class="suggestion-item" onclick="selectParticipant('${nameEsc}', '${unitEsc}')">${r.name}${r.unit ? ' - ' + r.unit : ''}</div>`;
    }).join('');
    container.style.display = 'block';
}

function selectParticipant(name, unit) {
    addMRParticipant(name, unit);
    document.getElementById('mrParticipantInput').value = '';
    document.getElementById('mrParticipantSuggestions').style.display = 'none';
}

function addMRParticipant(name, unit = '') {
    if (!window.currentMRParticipants) window.currentMRParticipants = [];

    if (!window.currentMRParticipants.find(p => p.name === name)) {
        window.currentMRParticipants.push({name, unit, isOrganizer: false});
        renderMRParticipants();
    }
}

function removeMRParticipant(index) {
    if (window.currentMRParticipants) {
        window.currentMRParticipants.splice(index, 1);
        renderMRParticipants();
    }
}

// GESTION TABLEAUX
function handleTableNav(event, tableId) {
    const input = event.target;
    const cell = input.closest('td');
    const row = cell.closest('tr');
    const tbody = row.closest('tbody');

    if (event.key === 'Tab') {
        event.preventDefault();
        const nextCell = cell.nextElementSibling;
        if (nextCell) {
            const nextInput = nextCell.querySelector('input, textarea');
            if (nextInput) nextInput.focus();
        } else {
            const nextRow = row.nextElementSibling;
            if (nextRow && !nextRow.classList.contains('separator-row')) {
                const firstCell = nextRow.querySelector('td');
                const firstInput = firstCell ? firstCell.querySelector('input, textarea') : null;
                if (firstInput) firstInput.focus();
            }
        }
    } else if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        addTableRow(tableId);
        setTimeout(() => {
            const rows = tbody.querySelectorAll('tr:not(.separator-row)');
            const lastRow = rows[rows.length - 1];
            const firstInput = lastRow ? lastRow.querySelector('input, textarea') : null;
            if (firstInput) firstInput.focus();
        }, 10);
    } else if (event.ctrlKey && event.key.toLowerCase() === 'l') {
        event.preventDefault();
        addTableSeparator(tableId);
    }
}

function addTableRow(tableId) {
    const table = document.getElementById(tableId);
    if (!table) return;
    const tbody = table.querySelector('tbody');
    const lastRow = tbody.querySelector('tr:not(.separator-row):last-child');
    if (!lastRow) return;

    const newRow = lastRow.cloneNode(true);
    newRow.querySelectorAll('input, textarea').forEach(input => input.value = '');

    const taskChipsContainer = newRow.querySelector('.task-chips-container');
    if (taskChipsContainer) taskChipsContainer.innerHTML = '';

    tbody.appendChild(newRow);
}

function addTableSeparator(tableId) {
    const table = document.getElementById(tableId);
    if (!table) return;
    const tbody = table.querySelector('tbody');
    const colCount = table.querySelectorAll('th').length;

    const sepRow = document.createElement('tr');
    sepRow.className = 'separator-row';
    sepRow.innerHTML = `<td colspan="${colCount}"></td>`;
    tbody.appendChild(sepRow);
}

function resetTable(tableId) {
    const table = document.getElementById(tableId);
    if (!table) return;
    const tbody = table.querySelector('tbody');
    const firstRow = tbody.querySelector('tr');
    if (!firstRow) return;

    tbody.innerHTML = '';
    const newRow = firstRow.cloneNode(true);
    newRow.querySelectorAll('input, textarea').forEach(input => input.value = '');

    const taskChipsContainer = newRow.querySelector('.task-chips-container');
    if (taskChipsContainer) taskChipsContainer.innerHTML = '';

    tbody.appendChild(newRow);
}

function getTableData(tableId) {
    const table = document.getElementById(tableId);
    if (!table) return [];
    const tbody = table.querySelector('tbody');
    const rows = tbody.querySelectorAll('tr');
    const data = [];

    rows.forEach(row => {
        if (row.classList.contains('separator-row')) {
            data.push({separator: true});
        } else {
            const cells = row.querySelectorAll('td');
            const rowData = {};
            cells.forEach((cell, index) => {
                const input = cell.querySelector('input, textarea');
                rowData[`col${index}`] = input ? input.value : '';
            });
            data.push(rowData);
        }
    });

    return data;
}

function loadTableData(tableId, data) {
    if (!data || data.length === 0) return;

    const table = document.getElementById(tableId);
    if (!table) return;
    const tbody = table.querySelector('tbody');
    tbody.innerHTML = '';

    data.forEach(rowData => {
        if (rowData.separator) {
            const colCount = table.querySelectorAll('th').length;
            const sepRow = document.createElement('tr');
            sepRow.className = 'separator-row';
            sepRow.innerHTML = `<td colspan="${colCount}"></td>`;
            tbody.appendChild(sepRow);
        } else {
            const row = document.createElement('tr');
            const colCount = Object.keys(rowData).length;

            for (let i = 0; i < colCount; i++) {
                const cell = document.createElement('td');
                const value = (rowData[`col${i}`] || '').replace(/"/g, '&quot;');

                if (tableId === 'discussionsTable' && (i === 3 || i === 4)) {
                    cell.innerHTML = `<textarea onkeydown="handleTableNav(event, '${tableId}')">${value}</textarea>`;

                    if (i === 4) {
                        cell.innerHTML += `
                            <div class="task-chips-container"></div>
                            <div style="margin-top: 6px; display: flex; gap: 6px;">
                                <button type="button" class="btn btn-secondary btn-small" onclick="createTaskFromDiscussion(this)"><span style="color: #ffffff;">‚ûï</span> T√¢che</button>
                                <button type="button" class="btn btn-secondary btn-small" onclick="linkExistingTask(this)">üîó Lier</button>
                            </div>
                        `;
                    }
                } else {
                    cell.innerHTML = `<input type="text" onkeydown="handleTableNav(event, '${tableId}')" value="${value}">`;
                }

                row.appendChild(cell);
            }

            tbody.appendChild(row);
        }
    });
}

function createTaskFromDiscussion(button) {
    alert('Fonctionnalit√© √† venir : cr√©er une nouvelle t√¢che');
}

function linkExistingTask(button) {
    alert('Fonctionnalit√© √† venir : lier une t√¢che existante');
}

// GESTION RESSOURCES
function openResourcesManagementModal() {
    loadMainUser();
    renderResourcesList();
    openModal('resourcesManagementModal');
}

function loadMainUser() {
    document.getElementById('mainUserName').value = mainUser.name || '';
    document.getElementById('mainUserGrade').value = mainUser.grade || '';
    document.getElementById('mainUserUnit').value = mainUser.unit || '';
    document.getElementById('mainUserEmail').value = mainUser.email || '';
}

function saveMainUser() {
    mainUser = {
        name: document.getElementById('mainUserName').value.trim(),
        grade: document.getElementById('mainUserGrade').value.trim(),
        unit: document.getElementById('mainUserUnit').value.trim(),
        email: document.getElementById('mainUserEmail').value.trim(),
        isMain: true
    };
    saveMainUserToStorage();
    alert('Utilisateur principal enregistr√©');
}

function renderResourcesList() {
    const container = document.getElementById('resourcesList');
    const countEl = document.getElementById('resourceCount');
    if (countEl) countEl.textContent = resources.length;

    if (resources.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 20px; color: #888;">Aucune ressource</div>';
        return;
    }

    container.innerHTML = resources.map((r, index) => `
        <div class="resource-item">
            <div class="resource-name">${r.name}</div>
            <div class="resource-grade">${r.grade || '-'}</div>
            <div class="resource-unit">${r.unit || '-'}</div>
            <div class="resource-email">${r.email || '-'}</div>
            <button class="btn btn-secondary btn-small" onclick="deleteResource(${index})" style="padding: 6px 12px;">üóëÔ∏è</button>
        </div>
    `).join('');
}

function addResource() {
    const name = document.getElementById('newResourceName').value.trim();
    const grade = document.getElementById('newResourceGrade').value.trim();
    const unit = document.getElementById('newResourceUnit').value.trim();
    const email = document.getElementById('newResourceEmail').value.trim();

    if (!name) {
        alert('Nom requis');
        return;
    }

    resources.push({name, grade, unit, email});
    saveResourcesToStorage();
    renderResourcesList();

    document.getElementById('newResourceName').value = '';
    document.getElementById('newResourceGrade').value = '';
    document.getElementById('newResourceUnit').value = '';
    document.getElementById('newResourceEmail').value = '';
}

function deleteResource(index) {
    if (!confirm('Supprimer cette ressource ?')) return;
    resources.splice(index, 1);
    saveResourcesToStorage();
    renderResourcesList();
}

function sortResources() {
    resources.sort((a, b) => a.name.localeCompare(b.name));
    saveResourcesToStorage();
    renderResourcesList();
}

function exportResources() {
    const rows = [];

    // Ligne utilisateur principal si d√©fini
    if (mainUser && mainUser.name) {
        rows.push({
            name: mainUser.name,
            grade: mainUser.grade || '',
            unit: mainUser.unit || '',
            email: mainUser.email || '',
            isMain: 'true'
        });
    }

    // Ressources normales
    resources.forEach(r => {
        rows.push({
            name: r.name,
            grade: r.grade || '',
            unit: r.unit || '',
            email: r.email || '',
            isMain: r.isMain ? 'true' : ''
        });
    });

    const header = 'Nom,Grade,Unit√©,Email,IsMain\n';
    const csv = header + rows.map(r =>
        `"${r.name}","${r.grade}","${r.unit}","${r.email}","${r.isMain}"`
    ).join('\n');

    const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'ressources_' + new Date().toISOString().split('T')[0] + '.csv';
    a.click();
    URL.revokeObjectURL(url);
}

function importResources(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const text = e.target.result;
            const lines = text.split('\n').filter(l => l.trim());
            const imported = [];
            let mainUserImported = null;

            for (let i = 1; i < lines.length; i++) {
                const match = lines[i].match(/"([^"]*)","([^"]*)","([^"]*)","([^"]*)","?([^"]*)"?/);
                if (match) {
                    const resource = {
                        name: match[1],
                        grade: match[2],
                        unit: match[3],
                        email: match[4]
                    };

                    // V√©rifier si c'est l'utilisateur principal
                    if (match[5] && match[5].toLowerCase() === 'true') {
                        resource.isMain = true;
                        mainUserImported = resource;
                    } else {
                        imported.push(resource);
                    }
                }
            }

            // Restaurer l'utilisateur principal si trouv√©
            if (mainUserImported) {
                mainUser = mainUserImported;
                saveMainUserToStorage();
                loadMainUser();
            }

            if (imported.length > 0) {
                resources.push(...imported);
                saveResourcesToStorage();
                renderResourcesList();
            }

            const total = imported.length + (mainUserImported ? 1 : 0);
            alert(`${total} ressource(s) import√©e(s)` + (mainUserImported ? ' (dont utilisateur principal)' : ''));
        } catch (err) {
            alert('Erreur lors de l\'import du fichier CSV');
        }
    };
    reader.readAsText(file);
    event.target.value = '';
}

// GESTION TAGS
function openTagsManagementModal() {
    renderTagsList();
    openModal('tagsManagementModal');
}

function renderTagsList() {
    const container = document.getElementById('tagsList');
    const countEl = document.getElementById('tagCount');
    if (countEl) countEl.textContent = meetingTags.length;

    if (meetingTags.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 20px; color: #888;">Aucun tag</div>';
        return;
    }

    container.innerHTML = meetingTags.map((tag, index) => {
        const escaped = tag.replace(/'/g, "\'").replace(/"/g, '&quot;');
        return `<span class="tag-chip">${tag}<button onclick="deleteTag(${index})">√ó</button></span>`;
    }).join('');
}

function addTag() {
    const input = document.getElementById('newTagInput');
    const tag = input.value.trim();

    if (!tag) {
        alert('Tag vide');
        return;
    }

    if (meetingTags.includes(tag)) {
        alert('Ce tag existe d√©j√†');
        return;
    }

    meetingTags.push(tag);
    saveMeetingTagsToStorage();
    renderTagsList();
    input.value = '';
}

function deleteTag(index) {
    if (!confirm('Supprimer ce tag ?')) return;
    meetingTags.splice(index, 1);
    saveMeetingTagsToStorage();
    renderTagsList();
}

function sortTags() {
    meetingTags.sort((a, b) => a.localeCompare(b));
    saveMeetingTagsToStorage();
    renderTagsList();
}

// INT√âGRATION AU CALENDRIER
(function() {
    const originalRenderCalendar = typeof renderCalendar !== 'undefined' ? renderCalendar : function() {};
    window.renderCalendar = function() {
        if (!currentCalendarDate) {
            currentCalendarDate = new Date();
        }

        originalRenderCalendar();

        const grid = document.getElementById('calendarGrid');
        if (!grid) return;

        const year = currentCalendarDate.getFullYear();
        const month = currentCalendarDate.getMonth();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        for (let day = 1; day <= daysInMonth; day++) {
            let dayMRs = meetingReports.filter(mr => {
                if (!mr.statusDate) return false;
                const mrDate = new Date(mr.statusDate);
                return mrDate.getDate() === day && 
                       mrDate.getMonth() === month && 
                       mrDate.getFullYear() === year;
            });

            if (currentView !== 'general' && currentView !== 'reunions') {
                dayMRs = dayMRs.filter(mr => 
                    mr.sections && mr.sections.some(s => s.toLowerCase() === currentView.toLowerCase())
                );
            }

            if (dayMRs.length > 0) {
                const dayDivs = grid.querySelectorAll('.calendar-day');
                const dayDiv = dayDivs[day - 1];
                if (dayDiv) {
                    dayMRs.forEach(mr => {
                        const statusIcon = mr.status === 'brouillon' ? '‚ö™' : mr.status === 'encours' ? 'üü†' : 'üü¢';
                        const mrElement = document.createElement('div');
                        mrElement.className = 'calendar-task meeting';
                        mrElement.innerHTML = `üìã ${statusIcon} ${mr.title}`;
                        mrElement.onclick = (e) => {
                            e.stopPropagation();
                            showMRDetail(mr.id, e);
                        };
                        dayDiv.appendChild(mrElement);
                    });
                }
            }
        }
    };
})();

function showMRDetail(mrId, event) {
    const mr = meetingReports.find(m => m.id === mrId);
    if (!mr) return;

    const bubble = document.getElementById('calendarTaskDetail');
    if (!bubble) return;

    document.getElementById('detailTitle').textContent = `üìã ${mr.title}`;

    const statusIcon = mr.status === 'brouillon' ? '‚ö™' : mr.status === 'encours' ? 'üü†' : 'üü¢';
    const statusLabel = mr.status === 'brouillon' ? 'Brouillon' : mr.status === 'encours' ? 'En cours' : 'Valid√©';

    const sectionEl = document.getElementById('detailSection');
    const sectionsText = mr.sections && mr.sections.length > 0 ? mr.sections.join(', ') : 'G√©n√©ral';
    sectionEl.textContent = sectionsText;
    sectionEl.style.background = 'rgba(142, 68, 173, 0.3)';
    sectionEl.style.color = '#ba68c8';
    sectionEl.style.display = 'inline-block';

    const descEl = document.getElementById('detailDescription');
    descEl.textContent = `${statusIcon} ${statusLabel} - ${formatDateDisplay(mr.statusDate)}`;
    descEl.style.display = 'block';

    const metaItems = [];
    if (mr.participants && mr.participants.length > 0) {
        metaItems.push(`<div class="calendar-task-detail-meta-item">üë• ${mr.participants.length} participants</div>`);
    }
    if (mr.tags && mr.tags.length > 0) {
        metaItems.push(`<div class="calendar-task-detail-meta-item">üè∑Ô∏è ${mr.tags.join(', ')}</div>`);
    }

    const metaEl = document.getElementById('detailMeta');
    metaEl.innerHTML = metaItems.join('');
    metaEl.style.display = metaItems.length > 0 ? 'flex' : 'none';

    const progressContainer = document.getElementById('detailProgressContainer');
    if (progressContainer) progressContainer.style.display = 'none';

    let left = event.pageX + 20, top = event.pageY;
    if (left + 350 > window.innerWidth) {
        left = event.pageX - 370;
    }
    bubble.style.left = left + 'px';
    bubble.style.top = top + 'px';
    bubble.classList.add('show');

    window.currentDetailMRId = mrId;

    window.originalEditCardFromDetail = window.editCardFromDetail;
    window.originalDeleteCardFromDetail = window.deleteCardFromDetail;

    window.editCardFromDetail = function() {
        closeTaskDetail();
        editMeetingReport(window.currentDetailMRId);
    };

    window.deleteCardFromDetail = function() {
        closeTaskDetail();
        deleteMeetingReport(window.currentDetailMRId);
    };
}

// Restaurer les fonctions originales lors de la fermeture
(function() {
    const originalCloseTaskDetail = typeof closeTaskDetail !== 'undefined' ? closeTaskDetail : function() {};
    window.closeTaskDetail = function() {
        originalCloseTaskDetail();

        if (window.originalEditCardFromDetail) {
            window.editCardFromDetail = window.originalEditCardFromDetail;
            window.deleteCardFromDetail = window.originalDeleteCardFromDetail;
        }
    };
})();

</script>

<!-- Modal Gestion Sections -->
<div id="sectionsManagementModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:9999; justify-content:center; align-items:center;">
    <div class="modal-content" style="background:rgba(40,40,40,0.98); border-radius:20px; padding:2rem; width:90%; max-width:600px; max-height:80vh; overflow-y:auto; box-shadow:0 10px 40px rgba(0,0,0,0.8);">
        <div class="modal-header" style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:1rem; margin-bottom:1.5rem;">
            <h2 style="margin:0; color:white; font-size:1.8rem;">üìã Gestion des Sections</h2>
            <span class="close-modal" onclick="closeSectionsManagementModal()" style="font-size:2rem; color:rgba(255,255,255,0.6); cursor:pointer; transition:color 0.3s;">&times;</span>
        </div>
        <div id="sectionsList" style="margin-bottom:1.5rem;"></div>
        <div style="text-align:center;">
            <button class="btn" onclick="openSectionModal()" style="background:#6495ed; color:white; padding:1rem 2rem; border:none; border-radius:12px; cursor:pointer; font-size:1rem; font-weight:600; box-shadow:0 4px 15px rgba(100,149,237,0.3);">
                ‚ûï Ajouter une section
            </button>
        </div>
    </div>
</div>

<!-- Modal Ajout/Modification Section -->
<div id="sectionModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:10000; justify-content:center; align-items:center;">
    <div class="modal-content" style="background:rgba(40,40,40,0.98); border-radius:20px; padding:2rem; width:90%; max-width:400px; box-shadow:0 10px 40px rgba(0,0,0,0.8);">
        <div class="modal-header" style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:1rem; margin-bottom:1.5rem;">
            <h2 id="sectionModalTitle" style="margin:0; color:white; font-size:1.6rem;">Ajouter Section</h2>
            <span class="close-modal" onclick="closeSectionModal()" style="font-size:2rem; color:rgba(255,255,255,0.6); cursor:pointer; transition:color 0.3s;">&times;</span>
        </div>
        <div style="margin-bottom:1.5rem;">
            <label for="sectionName" style="display:block; color:rgba(255,255,255,0.9); font-weight:500; margin-bottom:0.5rem;">Nom de la section</label>
            <input type="text" id="sectionName" placeholder="Ex: Nouvelle section" style="width:100%; padding:1rem; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); border-radius:12px; color:white; font-size:1rem; outline:none;" />
            <input type="hidden" id="editingSectionId" value="" />
        </div>
        <div style="text-align:center;">
            <button class="btn" onclick="saveSection()" style="background:#6495ed; color:white; padding:1rem 2rem; border:none; border-radius:12px; cursor:pointer; font-size:1rem; font-weight:600; width:100%; box-shadow:0 4px 15px rgba(100,149,237,0.3);">
                Enregistrer
            </button>
        </div>
    </div>
</div>

    <!-- Footer Copyright -->
    <div class="footer">
        ¬© 2025, CEN Damien SICHAUMETTE
    </div>

    <!-- ============================================ -->
    <!-- MODALES COMPTES RENDUS DE R√âUNION - V80     -->
    <!-- ============================================ -->

    <!-- Modal Liste CR -->
    <div class="modal" id="meetingReportsListModal">
        <div class="modal-content" style="max-width: 1200px;">
            <div class="modal-header">
                <h2>üìã Comptes Rendus de R√©union</h2>
                <span class="close-modal" onclick="closeModal('meetingReportsListModal')">√ó</span>
            </div>
            <div class="form-group" style="padding: 20px;">
                <button class="btn" onclick="openMeetingReportModal()" style="margin-bottom: 20px;">
                    <span style="color: #ffffff; font-size: 18px;">‚ûï</span> Nouveau Compte Rendu
                </button>

                <div id="meetingReportsList" style="display: flex; flex-direction: column; gap: 15px;">
                    <!-- Les CR seront affich√©s ici -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal √âdition CR -->
    <div class="modal" id="meetingReportModal">
        <div class="modal-content" style="max-width: 1200px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header" style="position: sticky; top: 0; z-index: 10; background: rgba(40,40,40,0.98);">
                <h2 id="meetingReportModalTitle">üìã Nouveau Compte Rendu</h2>
                <span class="close-modal" onclick="closeModal('meetingReportModal')">√ó</span>
            </div>

            <div style="padding: 30px;">
                <!-- Titre -->
                <div class="form-group">
                    <label>Titre du compte rendu</label>
                    <input type="text" id="mrTitle" placeholder="ex: CR R√©union hebdo DGCE 22-12-2025">
                </div>

                <!-- Statut et Date -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Statut</label>
                        <select id="mrStatus">
                            <option value="brouillon">‚ö™ Brouillon</option>
                            <option value="encours">üü† En cours</option>
                            <option value="valide">üü¢ Valid√©</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Date du statut</label>
                        <input type="date" id="mrStatusDate">
                    </div>
                </div>

                <!-- Tags -->
                <div class="form-group">
                    <label>Tags <span style="font-size: 0.85em; color: #888;">(optionnel)</span></label>
                    <div id="mrTagsContainer" class="tags-container">
                        <!-- Tags s√©lectionn√©s -->
                    </div>
                    <input type="text" id="mrTagInput" placeholder="Tapez pour ajouter un tag..." 
                           style="margin-top: 10px;" 
                           onkeydown="handleMRTagInput(event)"
                           oninput="showMRTagSuggestions(event)">
                    <div id="mrTagSuggestions" class="suggestions-dropdown">
                        <!-- Suggestions -->
                    </div>
                </div>

                <!-- Sections -->
                <div class="form-group">
                    <label>Sections du CR <span style="font-size: 0.85em; color: #888;">(appara√Ætra dans les calendriers s√©lectionn√©s)</span></label>
                    <div id="mrSectionsContainer" class="sections-checkboxes">
                        <!-- Cases √† cocher -->
                    </div>
                </div>

                <!-- Participants -->
                <div class="form-group">
                    <label>üë• Participants</label>
                    <div id="mrParticipantsContainer" class="participants-container">
                        <!-- Chips participants -->
                    </div>
                    <input type="text" id="mrParticipantInput" placeholder="Ajouter un participant..." 
                           style="margin-top: 10px;"
                           oninput="showParticipantSuggestions(event)"
                           onkeydown="handleParticipantInput(event)">
                    <div id="mrParticipantSuggestions" class="suggestions-dropdown">
                        <!-- Suggestions -->
                    </div>
                </div>

                <!-- Agenda -->
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        üìÖ Agenda
                        <span class="help-icon" title="Navigation : Tab (colonne suivante) | Entr√©e (nouvelle ligne) | Ctrl+L (s√©parateur)">?</span>
                    </label>

                    <h4 style="margin-top: 20px; margin-bottom: 10px; color: #aaa; font-size: 14px;">Semaine pass√©e</h4>
                    <div style="overflow-x: auto;">
                        <table id="agendaPast" class="mr-table">
                            <thead>
                                <tr>
                                    <th style="width: 15%;">Quand</th>
                                    <th style="width: 10%;">Heure</th>
                                    <th style="width: 35%;">Quoi</th>
                                    <th style="width: 20%;">Qui</th>
                                    <th style="width: 20%;">Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><input type="text" onkeydown="handleTableNav(event, 'agendaPast')"></td>
                                    <td><input type="text" onkeydown="handleTableNav(event, 'agendaPast')"></td>
                                    <td><input type="text" onkeydown="handleTableNav(event, 'agendaPast')"></td>
                                    <td><input type="text" onkeydown="handleTableNav(event, 'agendaPast')"></td>
                                    <td><input type="text" onkeydown="handleTableNav(event, 'agendaPast')"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div style="margin-top: 8px; display: flex; gap: 8px;">
                        <button type="button" class="btn btn-secondary" onclick="addTableRow('agendaPast')"><span style="color: #ffffff; font-size: 16px;">‚ûï</span> Ligne</button>
                        <button type="button" class="btn btn-secondary" onclick="addTableSeparator('agendaPast')">‚îÑ S√©parateur</button>
                    </div>

                    <h4 style="margin-top: 25px; margin-bottom: 10px; color: #aaa; font-size: 14px;">Semaine en cours</h4>
                    <div style="overflow-x: auto;">
                        <table id="agendaCurrent" class="mr-table">
                            <thead>
                                <tr>
                                    <th style="width: 15%;">Quand</th>
                                    <th style="width: 10%;">Heure</th>
                                    <th style="width: 35%;">Quoi</th>
                                    <th style="width: 20%;">Qui</th>
                                    <th style="width: 20%;">Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><input type="text" onkeydown="handleTableNav(event, 'agendaCurrent')"></td>
                                    <td><input type="text" onkeydown="handleTableNav(event, 'agendaCurrent')"></td>
                                    <td><input type="text" onkeydown="handleTableNav(event, 'agendaCurrent')"></td>
                                    <td><input type="text" onkeydown="handleTableNav(event, 'agendaCurrent')"></td>
                                    <td><input type="text" onkeydown="handleTableNav(event, 'agendaCurrent')"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div style="margin-top: 8px; display: flex; gap: 8px;">
                        <button type="button" class="btn btn-secondary" onclick="addTableRow('agendaCurrent')"><span style="color: #ffffff; font-size: 16px;">‚ûï</span> Ligne</button>
                        <button type="button" class="btn btn-secondary" onclick="addTableSeparator('agendaCurrent')">‚îÑ S√©parateur</button>
                    </div>

                    <h4 style="margin-top: 25px; margin-bottom: 10px; color: #aaa; font-size: 14px;">√Ä venir</h4>
                    <div style="overflow-x: auto;">
                        <table id="agendaNext" class="mr-table">
                            <thead>
                                <tr>
                                    <th style="width: 15%;">Quand</th>
                                    <th style="width: 10%;">Heure</th>
                                    <th style="width: 35%;">Quoi</th>
                                    <th style="width: 20%;">Qui</th>
                                    <th style="width: 20%;">Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><input type="text" onkeydown="handleTableNav(event, 'agendaNext')"></td>
                                    <td><input type="text" onkeydown="handleTableNav(event, 'agendaNext')"></td>
                                    <td><input type="text" onkeydown="handleTableNav(event, 'agendaNext')"></td>
                                    <td><input type="text" onkeydown="handleTableNav(event, 'agendaNext')"></td>
                                    <td><input type="text" onkeydown="handleTableNav(event, 'agendaNext')"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div style="margin-top: 8px; display: flex; gap: 8px;">
                        <button type="button" class="btn btn-secondary" onclick="addTableRow('agendaNext')"><span style="color: #ffffff; font-size: 16px;">‚ûï</span> Ligne</button>
                        <button type="button" class="btn btn-secondary" onclick="addTableSeparator('agendaNext')">‚îÑ S√©parateur</button>
                    </div>
                </div>

                <!-- Points de discussion -->
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        üí¨ Points de discussion majeurs
                        <span class="help-icon" title="Navigation tableau + possibilit√© de cr√©er/lier des t√¢ches">?</span>
                    </label>
                    <div style="overflow-x: auto;">
                        <table id="discussionsTable" class="mr-table">
                            <thead>
                                <tr>
                                    <th style="width: 12%;">Section</th>
                                    <th style="width: 15%;">Qui</th>
                                    <th style="width: 20%;">Sujet</th>
                                    <th style="width: 25%;">Point</th>
                                    <th style="width: 28%;">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><input type="text" onkeydown="handleTableNav(event, 'discussionsTable')"></td>
                                    <td><input type="text" onkeydown="handleTableNav(event, 'discussionsTable')"></td>
                                    <td><input type="text" onkeydown="handleTableNav(event, 'discussionsTable')"></td>
                                    <td><textarea onkeydown="handleTableNav(event, 'discussionsTable')"></textarea></td>
                                    <td>
                                        <textarea onkeydown="handleTableNav(event, 'discussionsTable')" placeholder="Description action..."></textarea>
                                        <div class="task-chips-container"></div>
                                        <div style="margin-top: 6px; display: flex; gap: 6px;">
                                            <button type="button" class="btn btn-secondary btn-small" onclick="createTaskFromDiscussion(this)"><span style="color: #ffffff;">‚ûï</span> T√¢che</button>
                                            <button type="button" class="btn btn-secondary btn-small" onclick="linkExistingTask(this)">üîó Lier</button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div style="margin-top: 8px; display: flex; gap: 8px;">
                        <button type="button" class="btn btn-secondary" onclick="addTableRow('discussionsTable')"><span style="color: #ffffff; font-size: 16px;">‚ûï</span> Ligne</button>
                        <button type="button" class="btn btn-secondary" onclick="addTableSeparator('discussionsTable')">‚îÑ S√©parateur</button>
                    </div>
                </div>

                <button class="btn" onclick="saveMeetingReport()" style="margin-top: 20px;">üíæ Enregistrer</button>
            </div>
        </div>
    </div>

    <!-- Modal Gestion des Ressources -->
    <div class="modal" id="resourcesManagementModal">
        <div class="modal-content" style="max-width: 1100px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header" style="position: sticky; top: 0; z-index: 10; background: rgba(40,40,40,0.98);">
                <h2>üë• Gestion des Ressources / Collaborateurs</h2>
                <span class="close-modal" onclick="closeModal('resourcesManagementModal')">√ó</span>
            </div>

            <div style="padding: 30px;">
                <div class="info-box">
                    üí° <strong>Info :</strong> Cette liste est utilis√©e pour l'autocompl√©tion dans les CR et les ressources des t√¢ches.
                </div>

                <!-- Utilisateur principal -->
                <div class="form-group">
                    <h3 style="margin-bottom: 15px; font-size: 16px;">‚≠ê Utilisateur Principal</h3>
                    <div class="user-card">
                        <div class="user-badge">VOUS</div>
                        <div class="user-grid-4">
                            <div class="form-field">
                                <label>Nom complet *</label>
                                <input type="text" id="mainUserName" placeholder="ex: DUPONT Jean LTN">
                            </div>
                            <div class="form-field">
                                <label>Grade / Fonction</label>
                                <input type="text" id="mainUserGrade" placeholder="ex: LTN">
                            </div>
                            <div class="form-field">
                                <label>Unit√© / Service *</label>
                                <input type="text" id="mainUserUnit" placeholder="ex: DGCE D2AC">
                            </div>
                            <div class="form-field">
                                <label>Email (optionnel)</label>
                                <input type="text" id="mainUserEmail" placeholder="ex: prenom.nom@...">
                            </div>
                        </div>
                        <div style="display: flex; justify-content: flex-end; margin-top: 15px;">
                            <button class="btn" onclick="saveMainUser()">üíæ Enregistrer</button>
                        </div>
                    </div>
                </div>

                <!-- Liste ressources -->
                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0; font-size: 16px;">üìã Liste des Ressources (<span id="resourceCount">0</span>)</h3>
                    </div>

                    <div id="resourcesList" class="resources-list">
                        <!-- Liste -->
                    </div>

                    <!-- Formulaire ajout -->
                    <div class="add-form">
                        <h4 style="margin-bottom: 15px; font-size: 14px; display: flex; align-items: center; gap: 8px;">
                            <span style="color: #ffffff; font-size: 18px;">‚ûï</span> Ajouter une ressource
                        </h4>
                        <div class="form-grid-4">
                            <div class="form-field">
                                <label>Nom complet *</label>
                                <input type="text" id="newResourceName" placeholder="ex: MARTIN Sophie">
                            </div>
                            <div class="form-field">
                                <label>Grade / Fonction</label>
                                <input type="text" id="newResourceGrade" placeholder="ex: CDT">
                            </div>
                            <div class="form-field">
                                <label>Unit√© / Service</label>
                                <input type="text" id="newResourceUnit" placeholder="ex: DGCE SOA">
                            </div>
                            <div class="form-field">
                                <label>Email (optionnel)</label>
                                <input type="text" id="newResourceEmail" placeholder="ex: prenom.nom@...">
                            </div>
                        </div>
                        <div style="display: flex; justify-content: flex-end; margin-top: 15px;">
                            <button class="btn" onclick="addResource()">
                                <span style="color: #ffffff; font-size: 16px;">‚ûï</span> Ajouter
                            </button>
                        </div>
                    </div>

                    <!-- Boutons d'action EN BAS -->
                    <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                        <button class="btn btn-secondary btn-small" onclick="sortResources()">üî§ Trier A-Z</button>
                        <button class="btn btn-secondary btn-small" onclick="exportResources()">üì§ Export CSV</button>
                        <button class="btn btn-secondary btn-small" onclick="document.getElementById('importResourcesFile').click()">üì• Import CSV</button>
                        <input type="file" id="importResourcesFile" accept=".csv" style="display: none;" onchange="importResources(event)">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Gestion des Tags -->
    <div class="modal" id="tagsManagementModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>üè∑Ô∏è Gestion des Tags</h2>
                <span class="close-modal" onclick="closeModal('tagsManagementModal')">√ó</span>
            </div>

            <div style="padding: 30px;">
                <div class="info-box">
                    üí° <strong>Info :</strong> Ces tags seront utilis√©s pour cat√©goriser les CR et, prochainement, les t√¢ches.
                </div>

                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0; font-size: 16px;">üìã Tags disponibles (<span id="tagCount">0</span>)</h3>
                        <button class="btn btn-secondary btn-small" onclick="sortTags()">üî§ Trier A-Z</button>
                    </div>
                    <div id="tagsList" class="tags-list">
                        <!-- Tags -->
                    </div>

                    <!-- Formulaire ajout avec plus d'espace -->
                    <div style="margin-top: 28px;">
                        <label>Nouveau tag</label>
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <input type="text" id="newTagInput" placeholder="ex: COPIL, R√©union hebdo, MCIC2..." style="flex: 1;">
                            <button class="btn" onclick="addTag()">
                                <span style="color: #ffffff; font-size: 16px;">‚ûï</span> Ajouter
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


<script>
// R√©unions: vue int√©gr√©e (V92)
(function() {
  const origSwitchView = window.switchView;
  const origShowCalendar = window.showCalendar;
  const origShowAllTasks = window.showAllTasks;
  const origFilterOverdue = window.filterOverdue;
  const origFilterThisWeek = window.filterThisWeek;
  const origFilterThisMonth = window.filterThisMonth;

  function setActiveReunions(active) {
    const btn = document.getElementById('btn-reunions');
    if (!btn) return;
    btn.classList.toggle('active', !!active);
  }

  function hideReunionsView() {
    const v = document.getElementById('reunionsView');
    if (v) v.style.display = 'none';
  }

  function showReunionsView() {
    const v = document.getElementById('reunionsView');
    if (v) v.style.display = 'block';
    if (typeof renderMeetingReportsList === 'function') {
      renderMeetingReportsList();
    }
  }

  function exitReunionsToKanban() {
    hideReunionsView();
    setActiveReunions(false);
    const kanban = document.getElementById('kanbanContainer');
    if (kanban) kanban.style.display = 'flex';
  }

  // Patch switchView
  window.switchView = function(view) {
    const kanban = document.getElementById('kanbanContainer');
    const cal = document.getElementById('calendarView');

    if (view === 'reunions') {
      // D√©sactiver les boutons de section
      document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
      setActiveReunions(true);

      // Cacher Kanban / Calendrier
      if (kanban) kanban.style.display = 'none';
      if (cal) cal.classList.remove('show');

      showReunionsView();
      localStorage.setItem('currentView', 'reunions');
      return;
    }

    // Quitter R√©unions
    exitReunionsToKanban();

    // Revenir au comportement standard
    if (typeof origSwitchView === 'function') {
      origSwitchView(view);
    }
  };

  // Patch calendrier et filtres pour sortir de R√©unions
  window.showCalendar = function() {
    exitReunionsToKanban();
    if (typeof origShowCalendar === 'function') return origShowCalendar();
  };
  window.showAllTasks = function() {
    exitReunionsToKanban();
    if (typeof origShowAllTasks === 'function') return origShowAllTasks();
  };
  window.filterOverdue = function() {
    exitReunionsToKanban();
    if (typeof origFilterOverdue === 'function') return origFilterOverdue();
  };
  window.filterThisWeek = function() {
    exitReunionsToKanban();
    if (typeof origFilterThisWeek === 'function') return origFilterThisWeek();
  };
  window.filterThisMonth = function() {
    exitReunionsToKanban();
    if (typeof origFilterThisMonth === 'function') return origFilterThisMonth();
  };

  // Au chargement: restaurer la vue si besoin
  document.addEventListener('DOMContentLoaded', () => {
    const saved = localStorage.getItem('currentView');
    if (saved === 'reunions') {
      window.switchView('reunions');
    }
  });
})();
</script>

</body>
</html>
